<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Novel Indicator Report - {{ run_id }}</title>
  <style>
    :root { --ink:#15243a; --muted:#526176; --line:#cfdae9; --panel:#f6f9ff; --warn:#fff4ef; --warnline:#f1c8b8; }
    body { font-family: Helvetica, Arial, sans-serif; margin: 28px; color: var(--ink); }
    h1, h2, h3 { color: #0f2b5b; margin: 0 0 8px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid var(--line); padding: 8px; font-size: 12px; text-align: left; }
    th { background: #f2f6fc; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 10px; background:#e6eefc; margin-right:4px; }
    .section { margin-bottom: 24px; }
    .small { font-size: 11px; color: var(--muted); }
    .kpi-grid { display: grid; grid-template-columns: repeat(4, minmax(120px,1fr)); gap: 10px; margin: 12px 0 16px; }
    .kpi { border:1px solid var(--line); background: var(--panel); border-radius: 8px; padding: 10px; }
    .kpi label { display:block; font-size: 11px; color: var(--muted); }
    .kpi b { font-size: 16px; }
    .warn { border:1px solid var(--warnline); background:var(--warn); border-radius: 10px; padding: 10px; margin-top: 12px; }
  </style>
</head>
<body>
  <h1>Novel Indicator Forecasting Report</h1>
  <p class="small">Run: {{ run_id }} | Generated: {{ generated_at }}</p>

  <div class="kpi-grid">
    <div class="kpi"><label>Avg Composite Error</label><b>{{ '%.5f'|format(insights.avg_error) }}</b></div>
    <div class="kpi"><label>Avg Hit Rate</label><b>{{ '%.2f'|format(insights.avg_hit * 100) }}%</b></div>
    <div class="kpi"><label>Avg PnL</label><b>{{ '%.4f'|format(insights.avg_pnl) }}</b></div>
    <div class="kpi"><label>Positive-PnL Assets</label><b>{{ '%.1f'|format(insights.positive_ratio * 100) }}%</b></div>
  </div>

  <div class="section">
    <h2>Executive Summary</h2>
    <p>Primary objective: pure prediction error minimization across purged walk-forward folds.</p>
    <p>Universal recommendation horizon: <strong>{{ universal.best_horizon }} bars</strong></p>
    <p>Universal composite error: <strong>{{ '%.6f'|format(universal.score.composite_error) }}</strong></p>
    <p>Universal hit rate: <strong>{{ '%.3f'|format(universal.score.directional_hit_rate) }}</strong> | Universal PnL: <strong>{{ '%.4f'|format(universal.score.pnl_total) }}</strong></p>
    <p>
      {% for spec in universal.indicator_combo %}
      <span class="pill">{{ spec.indicator_id }}</span>
      {% endfor %}
    </p>
  </div>

  <div class="section">
    <h2>Universal Indicator Formulae</h2>
    <table>
      <thead><tr><th>ID</th><th>Expression</th><th>Complexity</th></tr></thead>
      <tbody>
      {% for spec in universal.indicator_combo %}
        <tr>
          <td>{{ spec.indicator_id }}</td>
          <td>{{ spec.expression }}</td>
          <td>{{ spec.complexity }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="section">
    <h2>Per-Asset Diagnostics</h2>
    <table>
      <thead>
        <tr>
          <th>Symbol</th>
          <th>TF</th>
          <th>Best Horizon</th>
          <th>Composite Error</th>
          <th>NRMSE</th>
          <th>NMAE</th>
          <th>Hit Rate</th>
          <th>PnL</th>
          <th>Max DD</th>
          <th>Turnover</th>
          <th>Stability</th>
        </tr>
      </thead>
      <tbody>
      {% for rec in per_asset %}
        <tr>
          <td>{{ rec.symbol }}</td>
          <td>{{ rec.timeframe }}</td>
          <td>{{ rec.best_horizon }}</td>
          <td>{{ '%.6f'|format(rec.score.composite_error) }}</td>
          <td>{{ '%.6f'|format(rec.score.normalized_rmse) }}</td>
          <td>{{ '%.6f'|format(rec.score.normalized_mae) }}</td>
          <td>{{ '%.3f'|format(rec.score.directional_hit_rate) }}</td>
          <td>{{ '%.4f'|format(rec.score.pnl_total) }}</td>
          <td>{{ '%.4f'|format(rec.score.max_drawdown) }}</td>
          <td>{{ '%.4f'|format(rec.score.turnover) }}</td>
          <td>{{ '%.3f'|format(rec.score.stability_score) }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  {% if insights.warnings %}
  <div class="warn">
    <h3>Quality Warnings</h3>
    <ul>
      {% for warning in insights.warnings %}
      <li>{{ warning }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <div class="section">
    <h2>Methodology Snapshot</h2>
    <ul>
      <li>Binance spot OHLCV ingestion for dynamic top-volume USDT universe.</li>
      <li>Symbolic indicator generation with novelty and collinearity constraints.</li>
      <li>Adaptive coarse-to-fine horizon search over 3..200 bars.</li>
      <li>Purged walk-forward cross validation with embargo.</li>
      <li>Secondary backtest diagnostics with fees and slippage.</li>
    </ul>
  </div>

  <div class="section">
    <h2>Limitations And Failure Modes</h2>
    <p class="small">Results are sensitive to regime shift, exchange microstructure drift, and data quality anomalies. Use this as research output, not direct execution advice.</p>
  </div>
</body>
</html>
