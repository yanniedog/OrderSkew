(function(){"use strict";const z={top_n_symbols:6,timeframes:["5m","1h"],budget_minutes:35,random_seed:42},P="novel-indicator-browser-db",v="runs";let $=null,E=!1;const _=new Map,M=new Set;function R(){return new Date().toISOString()}function B(){return crypto.randomUUID().replace(/-/g,"").slice(0,12)}function C(t){const r=JSON.stringify(t);let e=2166136261;for(let s=0;s<r.length;s+=1)e^=r.charCodeAt(s),e=Math.imul(e,16777619);return`cfg_${(e>>>0).toString(16)}`}function I(t,r,e){const s=`${r}:${e}`;let n=2166136261;for(let i=0;i<s.length;i+=1)n^=s.charCodeAt(i),n=Math.imul(n,16777619);return t+(n>>>0)>>>0}function T(){return $||($=new Promise((t,r)=>{const e=indexedDB.open(P,1);e.onupgradeneeded=()=>{const s=e.result;s.objectStoreNames.contains(v)||s.createObjectStore(v,{keyPath:"id"})},e.onsuccess=()=>t(e.result),e.onerror=()=>r(e.error??new Error("IDB open error"))}),$)}async function S(t,r){const e=await T();await new Promise((s,n)=>{const i=e.transaction(v,"readwrite");i.objectStore(v).put({id:t,bundle:r}),i.oncomplete=()=>s(),i.onerror=()=>n(i.error??new Error("IDB write error"))})}async function j(){if(E)return;const t=await T(),r=await new Promise((e,s)=>{const i=t.transaction(v,"readonly").objectStore(v).getAll();i.onsuccess=()=>e(i.result??[]),i.onerror=()=>s(i.error??new Error("IDB read error"))});for(const e of r)e!=null&&e.id&&e.bundle&&_.set(e.id,e.bundle);E=!0}function O(t,r){const e=R();return{run:{run_id:t,status:"queued",stage:"created",progress:0,created_at:e,updated_at:e,config_hash:C(r),logs:[{timestamp:e,stage:"created",message:"Run created in browser engine."}]},config:r,summary:null,plots:{},telemetry:[],binanceCalls:[],pineScripts:{}}}function x(t,r,e,s,n){t.run.status=r,t.run.stage=e,t.run.progress=Math.max(0,Math.min(1,s)),t.run.updated_at=R(),t.run.logs.push({timestamp:t.run.updated_at,stage:e,message:n}),t.run.logs.length>300&&(t.run.logs=t.run.logs.slice(-300))}function A(t,r){const e=performance.memory;t.telemetry.push({...r,ts:R(),logical_cores:typeof navigator<"u"?navigator.hardwareConcurrency:null,device_memory_gb:typeof navigator<"u"?navigator.deviceMemory??null:null,js_heap_used_mb:e?e.usedJSHeapSize/(1024*1024):null,js_heap_limit_mb:e?e.jsHeapSizeLimit/(1024*1024):null,js_heap_percent:e?e.usedJSHeapSize/Math.max(e.jsHeapSizeLimit,1)*100:null,worker_busy_ratio:Math.max(0,Math.min(1,r.rate_units_per_sec/30)),storage_used_mb:JSON.stringify(t).length/(1024*1024)}),t.telemetry.length>1200&&(t.telemetry=t.telemetry.slice(-1200))}function U(t){let r=t>>>0;return()=>{r+=1831565813;let e=r;return e=Math.imul(e^e>>>15,e|1),e^=e+Math.imul(e^e>>>7,e|61),((e^e>>>14)>>>0)/4294967296}}function F(t,r,e){const s=["x-mbx-used-weight","x-mbx-used-weight-1m","x-mbx-order-count-10s","x-mbx-order-count-1m","date","content-type"],n={};for(const i of s){const d=e.headers.get(i);d!==null&&(n[i]=d)}t.binanceCalls.push({ts:R(),endpoint:r,status:e.status,headers:n}),t.binanceCalls.length>240&&(t.binanceCalls=t.binanceCalls.slice(-240))}function N(t,r){const e=new Float64Array(t.length);let s=0;for(let n=0;n<t.length;n+=1)s+=t[n],n>=r&&(s-=t[n-r]),e[n]=n>=r-1?s/r:t[n];return e}function D(t){if(!t.length)return 1;let r=0;for(const s of t)r+=s;r/=t.length;let e=0;for(const s of t){const n=s-r;e+=n*n}return Math.sqrt(Math.max(e/t.length,1e-9))}function H(t,r){let e=0;const s=Math.min(t.length,r.length);for(let n=0;n<s;n+=1)e+=Math.abs(t[n]-r[n]);return s?e/s:9999}function L(t,r){let e=0;const s=Math.min(t.length,r.length);for(let n=0;n<s;n+=1){const i=t[n]-r[n];e+=i*i}return s?Math.sqrt(e/s):9999}function J(t,r){const e=new Float64Array(t.length);e.fill(Number.NaN);for(let s=0;s<t.length-r;s+=1)e[s]=t[s+r];return e}function G(t,r,e){const s=[],n=[];for(let o=0;o<r.length;o+=1){if(!Number.isFinite(e[o]))continue;const a=t[o];Number.isFinite(a)&&(s.push(a),n.push((e[o]-r[o])/(r[o]+1e-9)))}if(s.length<50)return{yTrue:new Float64Array,yPred:new Float64Array,closeRef:new Float64Array};let i=0,d=0;for(let o=0;o<s.length;o+=1)i+=s[o]*s[o],d+=s[o]*n[o];const h=d/(i+1e-9),y=[],g=[],p=[];for(let o=0;o<r.length;o+=1){if(!Number.isFinite(e[o])||!Number.isFinite(t[o]))continue;const a=r[o]*(1+Math.max(-.8,Math.min(.8,h*t[o])));y.push(e[o]),g.push(a),p.push(r[o])}return{yTrue:Float64Array.from(y),yPred:Float64Array.from(g),closeRef:Float64Array.from(p)}}async function W(t,r){const e=await fetch("https://api.binance.com/api/v3/ticker/24hr");if(F(t,"/api/v3/ticker/24hr",e),!e.ok)throw new Error(`Binance universe request failed (${e.status})`);return(await e.json()).filter(n=>n.symbol.endsWith("USDT")).filter(n=>!/(UP|DOWN|BULL|BEAR)/.test(n.symbol)).map(n=>({symbol:n.symbol,quoteVolume:Number(n.quoteVolume||"0")})).sort((n,i)=>i.quoteVolume-n.quoteVolume).slice(0,r).map(n=>n.symbol)}async function K(t,r,e,s){const n={"5m":3e5,"1h":36e5,"4h":144e5},i=Date.now(),d=i-s*24*60*60*1e3,h=n[e]??6e4;let y=d;const g=[];for(;y<i;){const p=new URLSearchParams({symbol:r,interval:e,startTime:String(y),endTime:String(i),limit:"1000"}),o=await fetch(`https://api.binance.com/api/v3/klines?${p.toString()}`);if(F(t,"/api/v3/klines",o),!o.ok)throw new Error(`Binance klines failed (${o.status})`);const a=await o.json();if(!a.length)break;for(const c of a)g.push({timestamp:Number(c[0]),high:Number(c[2]),low:Number(c[3]),close:Number(c[4]),volume:Number(c[5])});const u=Number(a[a.length-1][0])+h;if(u<=y||(y=u,a.length<1e3))break}return g.sort((p,o)=>p.timestamp-o.timestamp),g}function Q(t,r){const e=Float64Array.from(t.map(o=>o.close)),s=Float64Array.from(t.map(o=>o.high)),n=Float64Array.from(t.map(o=>o.low)),i=U(r),d=[],h=[5,8,13,21,34,55],y=new Float64Array(e.length);for(let o=1;o<e.length;o+=1)y[o]=(e[o]-e[o-1])/(e[o-1]+1e-9);d.push({id:"cand_ret1",expr:"ret1(close)",pine:"(close - close[1]) / (close[1] + 1e-9)",complexity:2,feature:y});for(const o of h){const a=N(e,o),u=new Float64Array(e.length);for(let c=0;c<e.length;c+=1)u[c]=e[c]/(a[c]+1e-9);d.push({id:`cand_sma_${o}`,expr:`div(close,sma(close,${o}))`,pine:`close / (ta.sma(close, ${o}) + 1e-9)`,complexity:4,feature:u})}for(let o=0;o<24;o+=1){const a=h[Math.floor(i()*h.length)],u=h[Math.floor(i()*h.length)],c=N(e,a),m=N(e,u),l=new Float64Array(e.length);for(let f=0;f<e.length;f+=1)l[f]=(c[f]-m[f])/(Math.abs(m[f])+1e-9);d.push({id:`cand_combo_${o}`,expr:`div(sub(sma(close,${a}),sma(close,${u})),abs(sma(close,${u})))`,pine:`(ta.sma(close, ${a}) - ta.sma(close, ${u})) / (math.abs(ta.sma(close, ${u})) + 1e-9)`,complexity:6,feature:l})}const g=new Float64Array(e.length);for(let o=0;o<e.length;o+=1)g[o]=s[o]-n[o];d.push({id:"cand_range",expr:"sub(high,low)",pine:"high - low",complexity:2,feature:g});let p=null;for(const o of d)for(let a=3;a<=200;a+=12){const u=J(e,a),c=G(o.feature,e,u),m=L(c.yTrue,c.yPred)/(D(c.yTrue)+1e-9),l=H(c.yTrue,c.yPred)/Math.max(D(c.yTrue),1e-9),f=.5*(m+l);let b=0;for(let w=0;w<c.yTrue.length;w+=1){const te=Math.sign(c.yTrue[w]-c.closeRef[w]),re=Math.sign(c.yPred[w]-c.closeRef[w]);te===re&&(b+=1)}const k=c.yTrue.length?b/c.yTrue.length:0;(!p||f<p.composite)&&(p={symbol:"",timeframe:"",candidateId:o.id,expression:o.expr,pine:o.pine,complexity:o.complexity,horizon:a,composite:f,hitRate:k,yTrue:c.yTrue,yPred:c.yPred,closeRef:c.closeRef})}if(!p)throw new Error("No valid candidate found");return p}function X(t,r){var h,y,g,p,o;const e=r.map(a=>({symbol:a.symbol,timeframe:a.timeframe,best_horizon:a.horizon,indicator_combo:[{indicator_id:a.candidateId,expression:a.expression,complexity:a.complexity,params:{}}],score:{normalized_rmse:a.composite,normalized_mae:a.composite,composite_error:a.composite,directional_hit_rate:a.hitRate,pnl_total:0,max_drawdown:0,turnover:0,stability_score:1/(a.composite+1e-6)}})).sort((a,u)=>a.score.composite_error-u.score.composite_error),s={run_id:t,universal_recommendation:{symbol:"UNIVERSAL",timeframe:"5m|1h|4h",best_horizon:((h=e[0])==null?void 0:h.best_horizon)??3,indicator_combo:((y=e[0])==null?void 0:y.indicator_combo)??[],score:((g=e[0])==null?void 0:g.score)??{normalized_rmse:0,normalized_mae:0,composite_error:9999,directional_hit_rate:0,pnl_total:0,max_drawdown:0,turnover:0,stability_score:0}},per_asset_recommendations:e,generated_at:R()},n=r[0],i={horizon_heatmap:{run_id:t,plot_id:"horizon_heatmap",title:"Error by Horizon",payload:{type:"heatmap",x:[3,15,27,39],y:e.map(a=>`${a.symbol}:${a.timeframe}`),z:e.map(a=>[a.score.composite_error,a.score.composite_error,a.score.composite_error,a.score.composite_error])}},forecast_overlay:{run_id:t,plot_id:"forecast_overlay",title:"Forecast Overlay",payload:{type:"line",x:Array.from({length:Math.min(500,(n==null?void 0:n.yTrue.length)??0)},(a,u)=>u),series:[{name:"y_true",values:Array.from(((p=n==null?void 0:n.yTrue)==null?void 0:p.slice(0,500))??[])},{name:"y_pred",values:Array.from(((o=n==null?void 0:n.yPred)==null?void 0:o.slice(0,500))??[])}]}},novelty_pareto:{run_id:t,plot_id:"novelty_pareto",title:"Novelty/Complexity vs Accuracy",payload:{type:"scatter",points:r.map(a=>({label:`${a.symbol}:${a.timeframe}:${a.candidateId}`,complexity:a.complexity,error:a.composite}))}},timeframe_error:{run_id:t,plot_id:"timeframe_error",title:"Composite Error by Timeframe",payload:{type:"bar",categories:Array.from(new Set(e.map(a=>a.timeframe))),values:Array.from(new Set(e.map(a=>a.timeframe))).map(a=>{const u=e.filter(c=>c.timeframe===a);return u.reduce((c,m)=>c+m.score.composite_error,0)/Math.max(u.length,1)})}}},d={};for(const a of e.slice(0,3)){const u=a.indicator_combo[0].expression;d[`${a.symbol}_${a.timeframe}_indicator.pine`]=`//@version=6
indicator("${a.symbol} ${a.timeframe}", overlay=false)
value = ${u}
plot(value)`}return d["universal_indicator.pine"]=`//@version=6
indicator("Novel Indicator Universal", overlay=false)
value = close
plot(value)`,{summary:s,plots:i,pine:d}}async function Y(t){const r=_.get(t);if(!r)return;const e=Date.now();let s=Date.now();try{x(r,"running","universe",.05,"Selecting Binance universe in browser..."),A(r,{stage:"universe",working_on:"Binance universe query",achieved:"0 symbols",remaining:"pending",overall_progress:.05,stage_progress:.2,run_elapsed_sec:0,stage_elapsed_sec:0,eta_total_sec:null,eta_stage_sec:null,rate_units_per_sec:0}),await S(t,r);const n=await W(r,r.config.top_n_symbols),i=[],d=Math.max(1,n.length*r.config.timeframes.length);let h=0;x(r,"running","ingest",.15,`Ingesting ${n.length} symbols from Binance...`),await S(t,r);for(const g of n)for(const p of r.config.timeframes){if(M.has(t))throw new Error("Run canceled");s=Date.now(),x(r,"running","optimization",Math.min(.85,.15+h/d),`Optimizing ${g} ${p} locally...`);const o=p==="5m"?90:p==="1h"?365:365*2,a=await K(r,g,p,o);if(a.length>600){const u=Q(a,I(r.config.random_seed,g,p));u.symbol=g,u.timeframe=p,i.push(u)}h+=1,A(r,{stage:"optimization",working_on:`${g} ${p}`,achieved:`${h}/${d} datasets`,remaining:`${Math.max(0,d-h)} datasets`,overall_progress:Math.min(.85,.15+h/d),stage_progress:h/d,run_elapsed_sec:(Date.now()-e)/1e3,stage_elapsed_sec:(Date.now()-s)/1e3,eta_total_sec:null,eta_stage_sec:null,rate_units_per_sec:h/Math.max((Date.now()-e)/1e3,.1)}),await S(t,r)}if(!i.length)throw new Error("No valid datasets produced results");x(r,"running","ranking",.92,"Building summary and visual diagnostics...");const y=X(t,i);r.summary=y.summary,r.plots=y.plots,r.pineScripts=y.pine,x(r,"completed","finished",1,"Run completed fully in browser compute engine."),A(r,{stage:"finished",working_on:"Complete",achieved:"Run completed",remaining:"0",overall_progress:1,stage_progress:1,run_elapsed_sec:(Date.now()-e)/1e3,stage_elapsed_sec:(Date.now()-s)/1e3,eta_total_sec:0,eta_stage_sec:0,rate_units_per_sec:h/Math.max((Date.now()-e)/1e3,.1)}),await S(t,r)}catch(n){n.message==="Run canceled"?x(r,"canceled","finished",1,"Run canceled by user."):(r.run.error=n.message,x(r,"failed","finished",1,`Run failed: ${n.message}`)),await S(t,r)}finally{M.delete(t)}}function Z(){return Array.from(_.values()).map(t=>t.run).sort((t,r)=>Date.parse(r.created_at)-Date.parse(t.created_at))}function q(t){if(!t.summary)return"<html><body><h1>No report data.</h1></body></html>";const r=t.summary.per_asset_recommendations.map(e=>`<tr><td>${e.symbol}</td><td>${e.timeframe}</td><td>${e.best_horizon}</td><td>${e.score.composite_error.toFixed(6)}</td></tr>`).join("");return`<!doctype html><html><head><meta charset="utf-8"><title>Novel Indicator Report</title><style>body{font-family:Arial;padding:20px}table{border-collapse:collapse;width:100%}td,th{border:1px solid #ccc;padding:8px;text-align:left}</style></head><body><h1>Novel Indicator Report</h1><p>Run ${t.summary.run_id}</p><p>Generated ${t.summary.generated_at}</p><table><thead><tr><th>Symbol</th><th>TF</th><th>Horizon</th><th>Error</th></tr></thead><tbody>${r}</tbody></table></body></html>`}function V(t){return{run_id:t.run.run_id,source_version:"web-local-v1",sync_state:"synced",retained_at:R(),config:t.config,summary:t.summary,plots:Object.values(t.plots).map(r=>({plot_id:r.plot_id,payload:r.payload}))}}async function ee(t){var r,e,s,n,i,d,h,y,g,p,o,a,u,c;switch(await j(),t.method){case"init":return{ok:!0};case"createRun":{const m=Array.from(_.values()).find(w=>w.run.status==="queued"||w.run.status==="running");if(m)throw new Error(`Run already active (${m.run.run_id}). Cancel or wait before starting another.`);const l={...z,...(r=t.params)==null?void 0:r.config},f=B(),b=O(f,l);return _.set(f,b),await S(f,b),Y(f),{run_id:f,status:"queued",created_at:b.run.created_at}}case"listRuns":return Z();case"getRun":{const m=String(((e=t.params)==null?void 0:e.runId)??""),l=_.get(m);if(!l)throw new Error("Run not found");return l.run}case"getResults":{const m=String(((s=t.params)==null?void 0:s.runId)??""),l=_.get(m);if(!(l!=null&&l.summary))throw new Error("Results not found");return l.summary}case"getPlot":{const m=String(((n=t.params)==null?void 0:n.runId)??""),l=String(((i=t.params)==null?void 0:i.plotId)??""),f=(d=_.get(m))==null?void 0:d.plots[l];if(!f)throw new Error("Plot not found");return f}case"getTelemetry":{const m=String(((h=t.params)==null?void 0:h.runId)??""),l=Number(((y=t.params)==null?void 0:y.limit)??300),f=_.get(m);if(!f)throw new Error("Run not found");return{run_id:m,snapshots:f.telemetry.slice(-Math.max(1,Math.min(2e3,l)))}}case"getBinanceDiagnostics":{const m=String(((g=t.params)==null?void 0:g.runId)??""),l=Number(((p=t.params)==null?void 0:p.limit)??40),f=_.get(m);if(!f)throw new Error("Run not found");return{run_id:m,calls:f.binanceCalls.slice(-Math.max(1,Math.min(240,l)))}}case"cancelRun":{const m=String(((o=t.params)==null?void 0:o.runId)??"");if(!_.has(m))throw new Error("Run not found");return M.add(m),{ok:!0}}case"generateReport":{const m=String(((a=t.params)==null?void 0:a.runId)??""),l=_.get(m);if(!(l!=null&&l.summary))throw new Error("Run not found");return{html:q(l)}}case"exportPine":{const m=String(((u=t.params)==null?void 0:u.runId)??""),l=_.get(m);if(!(l!=null&&l.summary))throw new Error("Run not found");return{files:l.pineScripts}}case"getRunStoragePayload":{const m=String(((c=t.params)==null?void 0:c.runId)??""),l=_.get(m);if(!(l!=null&&l.summary))throw new Error("Run not found");return V(l)}default:throw new Error(`Unknown method ${t.method}`)}}self.onmessage=async t=>{const r=t.data;if(!(!(r!=null&&r.id)||!r.method))try{const e=await ee(r),s={id:r.id,ok:!0,result:e};self.postMessage(s)}catch(e){const s={id:r.id,ok:!1,error:e.message};self.postMessage(s)}}})();
