(function(){"use strict";const C={top_n_symbols:6,timeframes:["5m","1h"],budget_minutes:35,random_seed:42},B="novel-indicator-browser-db",R="runs";let M=null,T=!1;const y=new Map,j=new Set;function b(){return new Date().toISOString()}function O(){return crypto.randomUUID().replace(/-/g,"").slice(0,12)}function I(e){const n=JSON.stringify(e);let t=2166136261;for(let o=0;o<n.length;o+=1)t^=n.charCodeAt(o),t=Math.imul(t,16777619);return`cfg_${(t>>>0).toString(16)}`}function J(e,n,t){const o=`${n}:${t}`;let r=2166136261;for(let l=0;l<o.length;l+=1)r^=o.charCodeAt(l),r=Math.imul(r,16777619);return e+(r>>>0)>>>0}function z(){return M||(M=new Promise((e,n)=>{const t=indexedDB.open(B,1);t.onupgradeneeded=()=>{const o=t.result;o.objectStoreNames.contains(R)||o.createObjectStore(R,{keyPath:"id"})},t.onsuccess=()=>e(t.result),t.onerror=()=>n(t.error??new Error("IDB open error"))}),M)}async function $(e,n){const t=await z();await new Promise((o,r)=>{const l=t.transaction(R,"readwrite");l.objectStore(R).put({id:e,bundle:n}),l.oncomplete=()=>o(),l.onerror=()=>r(l.error??new Error("IDB write error"))})}async function U(){if(T)return;const e=await z(),n=await new Promise((t,o)=>{const l=e.transaction(R,"readonly").objectStore(R).getAll();l.onsuccess=()=>t(l.result??[]),l.onerror=()=>o(l.error??new Error("IDB read error"))});for(const t of n)t!=null&&t.id&&t.bundle&&y.set(t.id,t.bundle);T=!0}function H(e,n){const t=b();return{run:{run_id:e,status:"queued",stage:"created",progress:0,created_at:t,updated_at:t,config_hash:I(n),logs:[{timestamp:t,stage:"created",message:"Run created in browser engine."}]},config:n,summary:null,plots:{},telemetry:[],binanceCalls:[],pineScripts:{}}}function x(e,n,t,o,r){e.run.status=n,e.run.stage=t,e.run.progress=Math.max(0,Math.min(1,o)),e.run.updated_at=b(),e.run.logs.push({timestamp:e.run.updated_at,stage:t,message:r}),e.run.logs.length>300&&(e.run.logs=e.run.logs.slice(-300))}function A(e,n){const t=performance.memory;e.telemetry.push({...n,ts:b(),logical_cores:typeof navigator<"u"?navigator.hardwareConcurrency:null,device_memory_gb:typeof navigator<"u"?navigator.deviceMemory??null:null,js_heap_used_mb:t?t.usedJSHeapSize/(1024*1024):null,js_heap_limit_mb:t?t.jsHeapSizeLimit/(1024*1024):null,js_heap_percent:t?t.usedJSHeapSize/Math.max(t.jsHeapSizeLimit,1)*100:null,worker_busy_ratio:Math.max(0,Math.min(1,n.rate_units_per_sec/30)),storage_used_mb:JSON.stringify(e).length/(1024*1024)}),e.telemetry.length>1200&&(e.telemetry=e.telemetry.slice(-1200))}function L(e){let n=e>>>0;return()=>{n+=1831565813;let t=n;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}}function F(e,n,t){const o=["x-mbx-used-weight","x-mbx-used-weight-1m","x-mbx-order-count-10s","x-mbx-order-count-1m","date","content-type"],r={};for(const l of o){const i=t.headers.get(l);i!==null&&(r[l]=i)}e.binanceCalls.push({ts:b(),endpoint:n,status:t.status,headers:r}),e.binanceCalls.length>240&&(e.binanceCalls=e.binanceCalls.slice(-240))}function E(e,n){const t=new Float64Array(e.length);let o=0;for(let r=0;r<e.length;r+=1)o+=e[r],r>=n&&(o-=e[r-n]),t[r]=r>=n-1?o/n:e[r];return t}function D(e){if(!e.length)return 1;let n=0;for(const o of e)n+=o;n/=e.length;let t=0;for(const o of e){const r=o-n;t+=r*r}return Math.sqrt(Math.max(t/e.length,1e-9))}function G(e,n){let t=0;const o=Math.min(e.length,n.length);for(let r=0;r<o;r+=1)t+=Math.abs(e[r]-n[r]);return o?t/o:9999}function W(e,n){let t=0;const o=Math.min(e.length,n.length);for(let r=0;r<o;r+=1){const l=e[r]-n[r];t+=l*l}return o?Math.sqrt(t/o):9999}function K(e,n){const t=new Float64Array(e.length);t.fill(Number.NaN);for(let o=0;o<e.length-n;o+=1)t[o]=e[o+n];return t}function Q(e,n,t){const o=[],r=[];for(let s=0;s<n.length;s+=1){if(!Number.isFinite(t[s]))continue;const a=e[s];Number.isFinite(a)&&(o.push(a),r.push((t[s]-n[s])/(n[s]+1e-9)))}if(o.length<50)return{yTrue:new Float64Array,yPred:new Float64Array,closeRef:new Float64Array};let l=0,i=0;for(let s=0;s<o.length;s+=1)l+=o[s]*o[s],i+=o[s]*r[s];const u=i/(l+1e-9),g=[],h=[],f=[];for(let s=0;s<n.length;s+=1){if(!Number.isFinite(t[s])||!Number.isFinite(e[s]))continue;const a=n[s]*(1+Math.max(-.8,Math.min(.8,u*e[s])));g.push(t[s]),h.push(a),f.push(n[s])}return{yTrue:Float64Array.from(g),yPred:Float64Array.from(h),closeRef:Float64Array.from(f)}}async function X(e,n){const t=await fetch("https://api.binance.com/api/v3/ticker/24hr");if(F(e,"/api/v3/ticker/24hr",t),!t.ok)throw new Error(`Binance universe request failed (${t.status})`);return(await t.json()).filter(r=>r.symbol.endsWith("USDT")).filter(r=>!/(UP|DOWN|BULL|BEAR)/.test(r.symbol)).map(r=>({symbol:r.symbol,quoteVolume:Number(r.quoteVolume||"0")})).sort((r,l)=>l.quoteVolume-r.quoteVolume).slice(0,n).map(r=>r.symbol)}async function Y(e,n,t,o){const r={"5m":3e5,"1h":36e5,"4h":144e5},l=Date.now(),i=l-o*24*60*60*1e3,u=r[t]??6e4;let g=i;const h=[];for(;g<l;){const f=new URLSearchParams({symbol:n,interval:t,startTime:String(g),endTime:String(l),limit:"1000"}),s=await fetch(`https://api.binance.com/api/v3/klines?${f.toString()}`);if(F(e,"/api/v3/klines",s),!s.ok)throw new Error(`Binance klines failed (${s.status})`);const a=await s.json();if(!a.length)break;for(const m of a)h.push({timestamp:Number(m[0]),high:Number(m[2]),low:Number(m[3]),close:Number(m[4]),volume:Number(m[5])});const p=Number(a[a.length-1][0])+u;if(p<=g||(g=p,a.length<1e3))break}return h.sort((f,s)=>f.timestamp-s.timestamp),h}function Z(e,n){const t=Float64Array.from(e.map(s=>s.close)),o=Float64Array.from(e.map(s=>s.high)),r=Float64Array.from(e.map(s=>s.low)),l=L(n),i=[],u=[5,8,13,21,34,55],g=new Float64Array(t.length);for(let s=1;s<t.length;s+=1)g[s]=(t[s]-t[s-1])/(t[s-1]+1e-9);i.push({id:"cand_ret1",expr:"ret1(close)",pine:"(close - close[1]) / (close[1] + 1e-9)",complexity:2,feature:g});for(const s of u){const a=E(t,s),p=new Float64Array(t.length);for(let m=0;m<t.length;m+=1)p[m]=t[m]/(a[m]+1e-9);i.push({id:`cand_sma_${s}`,expr:`div(close,sma(close,${s}))`,pine:`close / (ta.sma(close, ${s}) + 1e-9)`,complexity:4,feature:p})}for(let s=0;s<24;s+=1){const a=u[Math.floor(l()*u.length)],p=u[Math.floor(l()*u.length)],m=E(t,a),w=E(t,p),d=new Float64Array(t.length);for(let c=0;c<t.length;c+=1)d[c]=(m[c]-w[c])/(Math.abs(w[c])+1e-9);i.push({id:`cand_combo_${s}`,expr:`div(sub(sma(close,${a}),sma(close,${p})),abs(sma(close,${p})))`,pine:`(ta.sma(close, ${a}) - ta.sma(close, ${p})) / (math.abs(ta.sma(close, ${p})) + 1e-9)`,complexity:6,feature:d})}const h=new Float64Array(t.length);for(let s=0;s<t.length;s+=1)h[s]=o[s]-r[s];i.push({id:"cand_range",expr:"sub(high,low)",pine:"high - low",complexity:2,feature:h});let f=null;for(const s of i)for(let a=3;a<=200;a+=12){const p=K(t,a),m=Q(s.feature,t,p),w=W(m.yTrue,m.yPred)/(D(m.yTrue)+1e-9),d=G(m.yTrue,m.yPred)/Math.max(D(m.yTrue),1e-9),c=.5*(w+d);let _=0;for(let S=0;S<m.yTrue.length;S+=1){const N=Math.sign(m.yTrue[S]-m.closeRef[S]),ae=Math.sign(m.yPred[S]-m.closeRef[S]);N===ae&&(_+=1)}const v=m.yTrue.length?_/m.yTrue.length:0;(!f||c<f.composite)&&(f={symbol:"",timeframe:"",candidateId:s.id,expression:s.expr,pine:s.pine,complexity:s.complexity,horizon:a,composite:c,hitRate:v,yTrue:m.yTrue,yPred:m.yPred,closeRef:m.closeRef})}if(!f)throw new Error("No valid candidate found");return f}function q(e,n){var u,g,h,f,s;const t=n.map(a=>({symbol:a.symbol,timeframe:a.timeframe,best_horizon:a.horizon,indicator_combo:[{indicator_id:a.candidateId,expression:a.expression,complexity:a.complexity,params:{}}],score:{normalized_rmse:a.composite,normalized_mae:a.composite,composite_error:a.composite,directional_hit_rate:a.hitRate,pnl_total:0,max_drawdown:0,turnover:0,stability_score:1/(a.composite+1e-6)}})).sort((a,p)=>a.score.composite_error-p.score.composite_error),o={run_id:e,universal_recommendation:{symbol:"UNIVERSAL",timeframe:"5m|1h|4h",best_horizon:((u=t[0])==null?void 0:u.best_horizon)??3,indicator_combo:((g=t[0])==null?void 0:g.indicator_combo)??[],score:((h=t[0])==null?void 0:h.score)??{normalized_rmse:0,normalized_mae:0,composite_error:9999,directional_hit_rate:0,pnl_total:0,max_drawdown:0,turnover:0,stability_score:0}},per_asset_recommendations:t,generated_at:b()},r=n[0],l={horizon_heatmap:{run_id:e,plot_id:"horizon_heatmap",title:"Error by Horizon",payload:{type:"heatmap",x:[3,15,27,39],y:t.map(a=>`${a.symbol}:${a.timeframe}`),z:t.map(a=>[a.score.composite_error,a.score.composite_error,a.score.composite_error,a.score.composite_error])}},forecast_overlay:{run_id:e,plot_id:"forecast_overlay",title:"Forecast Overlay",payload:{type:"line",x:Array.from({length:Math.min(500,(r==null?void 0:r.yTrue.length)??0)},(a,p)=>p),series:[{name:"y_true",values:Array.from(((f=r==null?void 0:r.yTrue)==null?void 0:f.slice(0,500))??[])},{name:"y_pred",values:Array.from(((s=r==null?void 0:r.yPred)==null?void 0:s.slice(0,500))??[])}]}},novelty_pareto:{run_id:e,plot_id:"novelty_pareto",title:"Novelty/Complexity vs Accuracy",payload:{type:"scatter",points:n.map(a=>({label:`${a.symbol}:${a.timeframe}:${a.candidateId}`,complexity:a.complexity,error:a.composite}))}},timeframe_error:{run_id:e,plot_id:"timeframe_error",title:"Composite Error by Timeframe",payload:{type:"bar",categories:Array.from(new Set(t.map(a=>a.timeframe))),values:Array.from(new Set(t.map(a=>a.timeframe))).map(a=>{const p=t.filter(m=>m.timeframe===a);return p.reduce((m,w)=>m+w.score.composite_error,0)/Math.max(p.length,1)})}}},i={};for(const a of t.slice(0,3)){const p=a.indicator_combo[0].expression;i[`${a.symbol}_${a.timeframe}_indicator.pine`]=`//@version=6
indicator("${a.symbol} ${a.timeframe}", overlay=false)
value = ${p}
plot(value)`}return i["universal_indicator.pine"]=`//@version=6
indicator("Novel Indicator Universal", overlay=false)
value = close
plot(value)`,{summary:o,plots:l,pine:i}}async function V(e){const n=y.get(e);if(!n)return;const t=Date.now();let o=Date.now();try{x(n,"running","universe",.05,"Selecting Binance universe in browser..."),A(n,{stage:"universe",working_on:"Binance universe query",achieved:"0 symbols",remaining:"pending",overall_progress:.05,stage_progress:.2,run_elapsed_sec:0,stage_elapsed_sec:0,eta_total_sec:null,eta_stage_sec:null,rate_units_per_sec:0}),await $(e,n);const r=await X(n,n.config.top_n_symbols),l=[],i=Math.max(1,r.length*n.config.timeframes.length);let u=0;x(n,"running","ingest",.15,`Ingesting ${r.length} symbols from Binance...`),await $(e,n);for(const h of r)for(const f of n.config.timeframes){if(j.has(e))throw new Error("Run canceled");o=Date.now(),x(n,"running","optimization",Math.min(.85,.15+u/i),`Optimizing ${h} ${f} locally...`);const s=f==="5m"?90:f==="1h"?365:365*2,a=await Y(n,h,f,s);if(a.length>600){const p=Z(a,J(n.config.random_seed,h,f));p.symbol=h,p.timeframe=f,l.push(p)}u+=1,A(n,{stage:"optimization",working_on:`${h} ${f}`,achieved:`${u}/${i} datasets`,remaining:`${Math.max(0,i-u)} datasets`,overall_progress:Math.min(.85,.15+u/i),stage_progress:u/i,run_elapsed_sec:(Date.now()-t)/1e3,stage_elapsed_sec:(Date.now()-o)/1e3,eta_total_sec:null,eta_stage_sec:null,rate_units_per_sec:u/Math.max((Date.now()-t)/1e3,.1)}),await $(e,n)}if(!l.length)throw new Error("No valid datasets produced results");x(n,"running","ranking",.92,"Building summary and visual diagnostics...");const g=q(e,l);n.summary=g.summary,n.plots=g.plots,n.pineScripts=g.pine,x(n,"completed","finished",1,"Run completed fully in browser compute engine."),A(n,{stage:"finished",working_on:"Complete",achieved:"Run completed",remaining:"0",overall_progress:1,stage_progress:1,run_elapsed_sec:(Date.now()-t)/1e3,stage_elapsed_sec:(Date.now()-o)/1e3,eta_total_sec:0,eta_stage_sec:0,rate_units_per_sec:u/Math.max((Date.now()-t)/1e3,.1)}),await $(e,n)}catch(r){r.message==="Run canceled"?x(n,"canceled","finished",1,"Run canceled by user."):(n.run.error=r.message,x(n,"failed","finished",1,`Run failed: ${r.message}`)),await $(e,n)}finally{j.delete(e)}}function ee(){return Array.from(y.values()).map(e=>e.run).sort((e,n)=>Date.parse(n.created_at)-Date.parse(e.created_at))}function k(e){if(!e.summary)return"<html><body><h1>No report data.</h1></body></html>";const n=e.summary.per_asset_recommendations.map(t=>`<tr><td>${t.symbol}</td><td>${t.timeframe}</td><td>${t.best_horizon}</td><td>${t.score.composite_error.toFixed(6)}</td></tr>`).join("");return`<!doctype html><html><head><meta charset="utf-8"><title>Novel Indicator Report</title><style>body{font-family:Arial;padding:20px}table{border-collapse:collapse;width:100%}td,th{border:1px solid #ccc;padding:8px;text-align:left}</style></head><body><h1>Novel Indicator Report</h1><p>Run ${e.summary.run_id}</p><p>Generated ${e.summary.generated_at}</p><table><thead><tr><th>Symbol</th><th>TF</th><th>Horizon</th><th>Error</th></tr></thead><tbody>${n}</tbody></table></body></html>`}function te(e){if(e==null)return"";const n=String(e);return/[,"\n]/.test(n)?`"${n.replace(/"/g,'""')}"`:n}function ne(e){const n=["symbol","timeframe","best_horizon","composite_error","directional_hit_rate","pnl_total","max_drawdown","indicator_ids","indicator_expressions"],t=e.per_asset_recommendations.map(o=>{const r=o.indicator_combo.map(i=>i.indicator_id).join("|"),l=o.indicator_combo.map(i=>i.expression).join("|");return[o.symbol,o.timeframe,o.best_horizon,o.score.composite_error,o.score.directional_hit_rate,o.score.pnl_total,o.score.max_drawdown,r,l]});return[n,...t].map(o=>o.map(r=>te(r)).join(",")).join(`
`)}function P(e){return e.length?`${e.map(n=>JSON.stringify(n)).join(`
`)}
`:""}function re(e){if(!e.summary)throw new Error("Run not found");const n=b(),t=[{path:"report/report.html",content:k(e),mime:"text/html;charset=utf-8"},{path:"run/run_status.json",content:JSON.stringify(e.run,null,2),mime:"application/json;charset=utf-8"},{path:"run/config.json",content:JSON.stringify(e.config,null,2),mime:"application/json;charset=utf-8"},{path:"results/summary.json",content:JSON.stringify(e.summary,null,2),mime:"application/json;charset=utf-8"},{path:"results/per_asset_recommendations.csv",content:ne(e.summary),mime:"text/csv;charset=utf-8"}],o=Object.values(e.plots).sort((i,u)=>i.plot_id.localeCompare(u.plot_id));for(const i of o)t.push({path:`plots/${i.plot_id}.json`,content:JSON.stringify({run_id:i.run_id,plot_id:i.plot_id,title:i.title,payload:i.payload},null,2),mime:"application/json;charset=utf-8"});const r=Object.entries(e.pineScripts).sort(([i],[u])=>i.localeCompare(u));for(const[i,u]of r)t.push({path:`pine/${i}`,content:u,mime:"text/plain;charset=utf-8"});e.telemetry.length>0&&t.push({path:"telemetry/telemetry.jsonl",content:P(e.telemetry),mime:"application/x-ndjson;charset=utf-8"}),e.binanceCalls.length>0&&t.push({path:"diagnostics/binance_calls.jsonl",content:P(e.binanceCalls),mime:"application/x-ndjson;charset=utf-8"});const l={run_id:e.run.run_id,generated_at:n,file_count:t.length+1,files:t.map(i=>({path:i.path,mime:i.mime}))};return t.unshift({path:"manifest.json",content:JSON.stringify(l,null,2),mime:"application/json;charset=utf-8"}),{run_id:e.run.run_id,generated_at:n,files:t}}function oe(e){return{run_id:e.run.run_id,source_version:"web-local-v1",sync_state:"synced",retained_at:b(),config:e.config,summary:e.summary,plots:Object.values(e.plots).map(n=>({plot_id:n.plot_id,payload:n.payload}))}}async function se(e){var n,t,o,r,l,i,u,g,h,f,s,a,p,m,w;switch(await U(),e.method){case"init":return{ok:!0};case"createRun":{const d=Array.from(y.values()).find(N=>N.run.status==="queued"||N.run.status==="running");if(d)throw new Error(`Run already active (${d.run.run_id}). Cancel or wait before starting another.`);const c={...C,...(n=e.params)==null?void 0:n.config},_=O(),v=H(_,c);return y.set(_,v),await $(_,v),V(_),{run_id:_,status:"queued",created_at:v.run.created_at}}case"listRuns":return ee();case"getRun":{const d=String(((t=e.params)==null?void 0:t.runId)??""),c=y.get(d);if(!c)throw new Error("Run not found");return c.run}case"getResults":{const d=String(((o=e.params)==null?void 0:o.runId)??""),c=y.get(d);if(!(c!=null&&c.summary))throw new Error("Results not found");return c.summary}case"getPlot":{const d=String(((r=e.params)==null?void 0:r.runId)??""),c=String(((l=e.params)==null?void 0:l.plotId)??""),_=(i=y.get(d))==null?void 0:i.plots[c];if(!_)throw new Error("Plot not found");return _}case"getTelemetry":{const d=String(((u=e.params)==null?void 0:u.runId)??""),c=Number(((g=e.params)==null?void 0:g.limit)??300),_=y.get(d);if(!_)throw new Error("Run not found");return{run_id:d,snapshots:_.telemetry.slice(-Math.max(1,Math.min(2e3,c)))}}case"getBinanceDiagnostics":{const d=String(((h=e.params)==null?void 0:h.runId)??""),c=Number(((f=e.params)==null?void 0:f.limit)??40),_=y.get(d);if(!_)throw new Error("Run not found");return{run_id:d,calls:_.binanceCalls.slice(-Math.max(1,Math.min(240,c)))}}case"cancelRun":{const d=String(((s=e.params)==null?void 0:s.runId)??"");if(!y.has(d))throw new Error("Run not found");return j.add(d),{ok:!0}}case"generateReport":{const d=String(((a=e.params)==null?void 0:a.runId)??""),c=y.get(d);if(!(c!=null&&c.summary))throw new Error("Run not found");return{html:k(c)}}case"exportPine":{const d=String(((p=e.params)==null?void 0:p.runId)??""),c=y.get(d);if(!(c!=null&&c.summary))throw new Error("Run not found");return{files:c.pineScripts}}case"exportRunBundle":{const d=String(((m=e.params)==null?void 0:m.runId)??""),c=y.get(d);if(!(c!=null&&c.summary))throw new Error("Run not found");return re(c)}case"getRunStoragePayload":{const d=String(((w=e.params)==null?void 0:w.runId)??""),c=y.get(d);if(!(c!=null&&c.summary))throw new Error("Run not found");return oe(c)}default:throw new Error(`Unknown method ${e.method}`)}}self.onmessage=async e=>{const n=e.data;if(!(!(n!=null&&n.id)||!n.method))try{const t=await se(n),o={id:n.id,ok:!0,result:t};self.postMessage(o)}catch(t){const o={id:n.id,ok:!1,error:t.message};self.postMessage(o)}}})();
