(function(){"use strict";const tt={top_n_symbols:6,timeframes:["5m","1h"],budget_minutes:35,random_seed:42},et="novel-indicator-browser-db",D="runs";let T=null,J=!1;const $=new Map,I=new Set;function A(){return new Date().toISOString()}function rt(){return crypto.randomUUID().replace(/-/g,"").slice(0,12)}function ot(e){const r=JSON.stringify(e);let t=2166136261;for(let s=0;s<r.length;s+=1)t^=r.charCodeAt(s),t=Math.imul(t,16777619);return`cfg_${(t>>>0).toString(16)}`}function nt(e,r,t){const s=`${r}:${t}`;let n=2166136261;for(let a=0;a<s.length;a+=1)n^=s.charCodeAt(a),n=Math.imul(n,16777619);return e+(n>>>0)>>>0}function q(){return T||(T=new Promise((e,r)=>{const t=indexedDB.open(et,1);t.onupgradeneeded=()=>{const s=t.result;s.objectStoreNames.contains(D)||s.createObjectStore(D,{keyPath:"id"})},t.onsuccess=()=>e(t.result),t.onerror=()=>r(t.error??new Error("IDB open error"))}),T)}async function P(e,r){const t=await q();await new Promise((s,n)=>{const a=t.transaction(D,"readwrite");a.objectStore(D).put({id:e,bundle:r}),a.oncomplete=()=>s(),a.onerror=()=>n(a.error??new Error("IDB write error"))})}async function at(){if(J)return;const e=await q(),r=await new Promise((t,s)=>{const a=e.transaction(D,"readonly").objectStore(D).getAll();a.onsuccess=()=>t(a.result??[]),a.onerror=()=>s(a.error??new Error("IDB read error"))});for(const t of r)t!=null&&t.id&&t.bundle&&$.set(t.id,t.bundle);J=!0}function st(e,r){const t=A();return{run:{run_id:e,status:"queued",stage:"created",progress:0,created_at:t,updated_at:t,config_hash:ot(r),logs:[{timestamp:t,stage:"created",message:"Run created in browser engine."}]},config:r,summary:null,plots:{},telemetry:[],binanceCalls:[],pineScripts:{}}}function E(e,r,t,s,n){e.run.status=r,e.run.stage=t,e.run.progress=Math.max(0,Math.min(1,s)),e.run.updated_at=A(),e.run.logs.push({timestamp:e.run.updated_at,stage:t,message:n}),e.run.logs.length>300&&(e.run.logs=e.run.logs.slice(-300))}function H(e,r){const t=performance.memory;e.telemetry.push({...r,ts:A(),logical_cores:typeof navigator<"u"?navigator.hardwareConcurrency:null,device_memory_gb:typeof navigator<"u"?navigator.deviceMemory??null:null,js_heap_used_mb:t?t.usedJSHeapSize/(1024*1024):null,js_heap_limit_mb:t?t.jsHeapSizeLimit/(1024*1024):null,js_heap_percent:t?t.usedJSHeapSize/Math.max(t.jsHeapSizeLimit,1)*100:null,worker_busy_ratio:Math.max(0,Math.min(1,r.rate_units_per_sec/30)),storage_used_mb:JSON.stringify(e).length/(1024*1024)}),e.telemetry.length>1200&&(e.telemetry=e.telemetry.slice(-1200))}function it(e){let r=e>>>0;return()=>{r+=1831565813;let t=r;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}}function lt(e,r,t){const s=["x-mbx-used-weight","x-mbx-used-weight-1m","x-mbx-order-count-10s","x-mbx-order-count-1m","date","content-type"],n={};for(const a of s){const m=t.headers.get(a);m!==null&&(n[a]=m)}e.binanceCalls.push({ts:A(),endpoint:r,status:t.status,headers:n}),e.binanceCalls.length>240&&(e.binanceCalls=e.binanceCalls.slice(-240))}function j(e,r){const t=new Float64Array(e.length);let s=0;for(let n=0;n<e.length;n+=1)s+=e[n],n>=r&&(s-=e[n-r]),t[n]=n>=r-1?s/r:e[n];return t}function G(e){if(!e.length)return 1;let r=0;for(const s of e)r+=s;r/=e.length;let t=0;for(const s of e){const n=s-r;t+=n*n}return Math.sqrt(Math.max(t/e.length,1e-9))}function ct(e,r){let t=0;const s=Math.min(e.length,r.length);for(let n=0;n<s;n+=1)t+=Math.abs(e[n]-r[n]);return s?t/s:9999}function mt(e,r){let t=0;const s=Math.min(e.length,r.length);for(let n=0;n<s;n+=1){const a=e[n]-r[n];t+=a*a}return s?Math.sqrt(t/s):9999}function ut(e,r){const t=new Float64Array(e.length);t.fill(Number.NaN);for(let s=0;s<e.length-r;s+=1)t[s]=e[s+r];return t}function O(e,r,t){return Math.max(r,Math.min(t,e))}function dt(e,r){const t=new Float64Array(e.length),s=new Float64Array(e.length+1),n=new Float64Array(e.length+1);for(let a=0;a<e.length;a+=1)s[a+1]=s[a]+e[a],n[a+1]=n[a]+e[a]*e[a];for(let a=0;a<e.length;a+=1){const m=Math.max(0,a-r+1),i=a-m+1,u=s[a+1]-s[m],d=n[a+1]-n[m],p=u/i;t[a]=Math.sqrt(Math.max(d/i-p*p,0))}return t}function k(e,r){const t=new Float64Array(e.length);if(!e.length)return t;const s=2/(r+1);t[0]=e[0];for(let n=1;n<e.length;n+=1)t[n]=s*e[n]+(1-s)*t[n-1];return t}function pt(e,r){const t=new Float64Array(e.length),s=new Float64Array(e.length);for(let i=1;i<e.length;i+=1){const u=e[i]-e[i-1];u>0?t[i]=u:s[i]=-u}const n=k(t,r),a=k(s,r),m=new Float64Array(e.length);for(let i=0;i<e.length;i+=1){const u=n[i]/(a[i]+1e-9);m[i]=100-100/(1+u)}return m}function ht(e,r){const t=e-r-1;if(t<320)return[];const s=4,n=Math.floor(t/(s+1));if(n<60)return[];const a=[];for(let m=0;m<s;m+=1){const i=n*(m+1),u=i+r,d=Math.min(u+n,t),p=Math.max(0,i-r),_=Math.max(0,d-u);if(p<120||_<40)continue;const y=new Int32Array(p);for(let f=0;f<p;f+=1)y[f]=f;const h=new Int32Array(_);for(let f=0;f<_;f+=1)h[f]=u+f;a.push({trainIdx:y,valIdx:h})}return a}function ft(e,r,t){let s=0,n=0,a=0,m=0,i=0;for(let f=0;f<t.length;f+=1){const x=t[f],o=e[x],l=r[x];!Number.isFinite(o)||!Number.isFinite(l)||(s+=o,n+=l,a+=o*o,m+=o*l,i+=1)}if(i<80)return null;const u=s/i,d=n/i,p=a-s*u;if(Math.abs(p)<1e-9)return null;const y=(m-s*d)/p;return{alpha:d-y*u,beta:y}}function gt(e,r,t,s){const n=ht(r.length,s);if(!n.length)return{yTrue:new Float64Array,yPred:new Float64Array,closeRef:new Float64Array};const a=new Float64Array(r.length);a.fill(Number.NaN);for(let d=0;d<r.length;d+=1)Number.isFinite(t[d])&&(a[d]=(t[d]-r[d])/(r[d]+1e-9));const m=[],i=[],u=[];for(const d of n){const p=ft(e,a,d.trainIdx);if(p)for(let _=0;_<d.valIdx.length;_+=1){const y=d.valIdx[_];if(!Number.isFinite(e[y])||!Number.isFinite(t[y]))continue;const h=O(p.alpha+p.beta*e[y],-.8,.8),f=r[y]*(1+h);m.push(t[y]),i.push(f),u.push(r[y])}}return{yTrue:Float64Array.from(m),yPred:Float64Array.from(i),closeRef:Float64Array.from(u)}}function yt(e,r,t,s){const n=Math.min(e.length,r.length,t.length);if(n<5)return{pnl:0,maxDrawdown:0,turnover:0,equity:[]};const a=.0012,m=new Float64Array(n);for(let h=0;h<n;h+=1){const f=(r[h]-t[h])/(t[h]+1e-9);f>s?m[h]=1:f<-s?m[h]=-1:m[h]=0}const i=new Float64Array(n);let u=0,d=1,p=1,_=0;const y=[];for(let h=0;h<n;h+=1){const f=h>0?m[h-1]:0,x=Math.abs(m[h]-f);u+=x;const o=(e[h]-t[h])/(t[h]+1e-9),l=f*o-a*x;i[h]=l,d*=1+l,d>p&&(p=d);const g=(d-p)/(p+1e-12);g<_&&(_=g),y.push(d)}return{pnl:d-1,maxDrawdown:_,turnover:u/n,equity:y}}async function W(e,r,t,s=4){let n=null;for(let a=0;a<s;a+=1)try{const m=await fetch(t);if(lt(e,r,m),m.status===429||m.status>=500){const i=350*Math.pow(2,a)+Math.floor(Math.random()*140);await new Promise(u=>setTimeout(u,i));continue}return m}catch(m){n=m;const i=350*Math.pow(2,a)+Math.floor(Math.random()*140);await new Promise(u=>setTimeout(u,i))}throw n||new Error(`Binance request failed: ${r}`)}async function _t(e,r){const t=await W(e,"/api/v3/ticker/24hr","https://api.binance.com/api/v3/ticker/24hr");if(!t.ok)throw new Error(`Binance universe request failed (${t.status})`);const s=await t.json(),n=new Set(["USDC","USDT","FDUSD","BUSD","TUSD","DAI","USDP","EUR","GBP"]);return s.filter(a=>a.symbol.endsWith("USDT")).filter(a=>!/(UP|DOWN|BULL|BEAR)/.test(a.symbol)).filter(a=>!n.has(a.symbol.slice(0,-4))).map(a=>{const m=Number(a.quoteVolume||"0"),i=Math.abs(Number(a.priceChangePercent||"0")),u=Number(a.count??0),d=Math.log10(m+1)*O(i/5,.2,2.2)*O(Math.log10(u+10)/4,.3,1.6);return{symbol:a.symbol,score:d}}).sort((a,m)=>m.score-a.score).slice(0,r).map(a=>a.symbol)}async function bt(e,r,t,s){const n={"5m":3e5,"1h":36e5,"4h":144e5},a=Date.now(),m=a-s*24*60*60*1e3,i=n[t]??6e4;let u=m;const d=[];for(;u<a;){const p=new URLSearchParams({symbol:r,interval:t,startTime:String(u),endTime:String(a),limit:"1000"}),_=await W(e,"/api/v3/klines",`https://api.binance.com/api/v3/klines?${p.toString()}`);if(!_.ok)throw new Error(`Binance klines failed (${_.status})`);const y=await _.json();if(!y.length)break;for(const f of y)d.push({timestamp:Number(f[0]),open:Number(f[1]),high:Number(f[2]),low:Number(f[3]),close:Number(f[4]),volume:Number(f[5])});const h=Number(y[y.length-1][0])+i;if(h<=u||(u=h,y.length<1e3))break}return d.sort((p,_)=>p.timestamp-_.timestamp),d}function wt(e,r){const t=Float64Array.from(e.map(c=>c.close)),s=Float64Array.from(e.map(c=>c.high)),n=Float64Array.from(e.map(c=>c.low)),a=Float64Array.from(e.map(c=>c.volume)),m=it(r),i=[],u=[5,8,13,21,34,55],d=new Float64Array(t.length);for(let c=1;c<t.length;c+=1)d[c]=(t[c]-t[c-1])/(t[c-1]+1e-9);i.push({id:"cand_ret1",expr:"ret1(close)",pine:"(close - close[1]) / (close[1] + 1e-9)",complexity:2,feature:d});const p=new Float64Array(t.length);for(let c=3;c<t.length;c+=1)p[c]=(t[c]-t[c-3])/(t[c-3]+1e-9);i.push({id:"cand_ret3",expr:"ret3(close)",pine:"(close - close[3]) / (close[3] + 1e-9)",complexity:2,feature:p});for(const c of u){const w=j(t,c),S=new Float64Array(t.length);for(let M=0;M<t.length;M+=1)S[M]=t[M]/(w[M]+1e-9)-1;i.push({id:`cand_sma_${c}`,expr:`div(close,sma(close,${c}))`,pine:`close / (ta.sma(close, ${c}) + 1e-9)`,complexity:4,feature:S})}const _=k(t,8),y=k(t,21),h=new Float64Array(t.length);for(let c=0;c<t.length;c+=1)h[c]=(_[c]-y[c])/(Math.abs(y[c])+1e-9);i.push({id:"cand_ema_gap",expr:"div(sub(ema(close,8),ema(close,21)),abs(ema(close,21)))",pine:"(ta.ema(close, 8) - ta.ema(close, 21)) / (math.abs(ta.ema(close, 21)) + 1e-9)",complexity:5,feature:h});const f=pt(t,14),x=new Float64Array(t.length);for(let c=0;c<t.length;c+=1)x[c]=(f[c]-50)/50;i.push({id:"cand_rsi14",expr:"sub(rsi(close,14),50)",pine:"(ta.rsi(close, 14) - 50) / 50",complexity:4,feature:x});const o=dt(d,20);i.push({id:"cand_ret_std20",expr:"std(ret1(close),20)",pine:"ta.stdev((close-close[1])/(close[1]+1e-9), 20)",complexity:4,feature:o});for(let c=0;c<24;c+=1){const w=u[Math.floor(m()*u.length)],S=u[Math.floor(m()*u.length)],M=j(t,w),B=j(t,S),b=new Float64Array(t.length);for(let N=0;N<t.length;N+=1)b[N]=(M[N]-B[N])/(Math.abs(B[N])+1e-9);i.push({id:`cand_combo_${c}`,expr:`div(sub(sma(close,${w}),sma(close,${S})),abs(sma(close,${S})))`,pine:`(ta.sma(close, ${w}) - ta.sma(close, ${S})) / (math.abs(ta.sma(close, ${S})) + 1e-9)`,complexity:6,feature:b})}const l=new Float64Array(t.length);for(let c=0;c<t.length;c+=1)l[c]=s[c]-n[c];i.push({id:"cand_range",expr:"sub(high,low)",pine:"high - low",complexity:2,feature:l});const g=new Float64Array(t.length);for(let c=0;c<t.length;c+=1)g[c]=l[c]/(Math.abs(t[c])+1e-9);i.push({id:"cand_range_norm",expr:"div(sub(high,low),close)",pine:"(high-low)/(math.abs(close)+1e-9)",complexity:3,feature:g});const R=j(a,21),U=new Float64Array(t.length);for(let c=0;c<t.length;c+=1)U[c]=a[c]/(R[c]+1e-9)-1;i.push({id:"cand_volume_ratio",expr:"div(volume,sma(volume,21))",pine:"volume/(ta.sma(volume,21)+1e-9)",complexity:4,feature:U});const F=[];for(const c of i){let w=null;const S={};for(let M=3;M<=200;M+=10){const B=ut(t,M),b=gt(c.feature,t,B,M);if(b.yTrue.length<120)continue;const N=mt(b.yTrue,b.yPred)/(G(b.yTrue)+1e-9);let K=0;for(let z=0;z<b.yTrue.length;z+=1)K+=Math.abs(b.yTrue[z]-b.closeRef[z]);const Q=ct(b.yTrue,b.yPred)/(K/b.yTrue.length+1e-9);let Z=0;for(let z=0;z<b.yTrue.length;z+=1){const Nt=Math.sign(b.yTrue[z]-b.closeRef[z]),Et=Math.sign(b.yPred[z]-b.closeRef[z]);Nt===Et&&(Z+=1)}const V=b.yTrue.length?Z/b.yTrue.length:0,L=.48*N+.34*Q+.18*(1-V);S[M]=L,(!w||L<w.composite)&&(w={horizon:M,normalizedRmse:N,normalizedMae:Q,composite:L,hitRate:V,yTrue:b.yTrue,yPred:b.yPred,closeRef:b.closeRef})}w&&F.push({candidate:{id:c.id,expr:c.expr,pine:c.pine,complexity:c.complexity},horizon:w.horizon,normalizedRmse:w.normalizedRmse,normalizedMae:w.normalizedMae,composite:w.composite,hitRate:w.hitRate,yTrue:w.yTrue,yPred:w.yPred,closeRef:w.closeRef,horizonScores:S})}if(!F.length)throw new Error("No valid candidate found");F.sort((c,w)=>c.composite-w.composite);const v=F[0],C=yt(v.yTrue,v.yPred,v.closeRef,.001),Ft=Float64Array.from(F.slice(0,6).map(c=>c.composite));return{symbol:"",timeframe:"",candidateId:v.candidate.id,expression:v.candidate.expr,pine:v.candidate.pine,complexity:v.candidate.complexity,horizon:v.horizon,normalizedRmse:v.normalizedRmse,normalizedMae:v.normalizedMae,composite:v.composite,hitRate:v.hitRate,pnl:C.pnl,maxDrawdown:C.maxDrawdown,turnover:C.turnover,stability:1/(G(Ft)+1e-6),equityCurve:C.equity,horizonScores:v.horizonScores,frontier:F.slice(0,14).map(c=>({label:c.candidate.id,complexity:c.candidate.complexity,error:c.composite,hitRate:c.hitRate})),yTrue:v.yTrue,yPred:v.yPred,closeRef:v.closeRef}}function xt(e,r){const t=r.map(o=>({symbol:o.symbol,timeframe:o.timeframe,best_horizon:o.horizon,indicator_combo:[{indicator_id:o.candidateId,expression:o.expression,complexity:o.complexity,params:{}}],score:{normalized_rmse:o.normalizedRmse,normalized_mae:o.normalizedMae,composite_error:o.composite,directional_hit_rate:o.hitRate,pnl_total:o.pnl,max_drawdown:o.maxDrawdown,turnover:o.turnover,stability_score:o.stability}})).sort((o,l)=>o.score.composite_error-l.score.composite_error),s=new Map;for(const o of r){const l=o.expression,g=s.get(l);if(!g){s.set(l,{count:1,totalError:o.composite,totalHit:o.hitRate,totalPnl:o.pnl,totalHorizon:o.horizon,sample:o});continue}g.count+=1,g.totalError+=o.composite,g.totalHit+=o.hitRate,g.totalPnl+=o.pnl,g.totalHorizon+=o.horizon}const n=Array.from(s.values()).sort((o,l)=>{const g=o.totalError/o.count+.03*(1-o.totalHit/o.count)+.05*Math.max(0,-(o.totalPnl/o.count)),R=l.totalError/l.count+.03*(1-l.totalHit/l.count)+.05*Math.max(0,-(l.totalPnl/l.count));return g-R})[0],a=(n==null?void 0:n.sample)??r[0],m={run_id:e,universal_recommendation:{symbol:"UNIVERSAL",timeframe:Array.from(new Set(r.map(o=>o.timeframe))).join("|"),best_horizon:n?Math.round(n.totalHorizon/n.count):(a==null?void 0:a.horizon)??3,indicator_combo:a?[{indicator_id:`${a.candidateId}_u`,expression:a.expression,complexity:a.complexity,params:{}}]:[],score:a?{normalized_rmse:n?n.totalError/n.count:a.normalizedRmse,normalized_mae:n?n.totalError/n.count:a.normalizedMae,composite_error:n?n.totalError/n.count:a.composite,directional_hit_rate:n?n.totalHit/n.count:a.hitRate,pnl_total:n?n.totalPnl/n.count:a.pnl,max_drawdown:a.maxDrawdown,turnover:a.turnover,stability_score:a.stability}:{normalized_rmse:9999,normalized_mae:9999,composite_error:9999,directional_hit_rate:0,pnl_total:0,max_drawdown:0,turnover:0,stability_score:0}},per_asset_recommendations:t,generated_at:A()},i=r[0],u=Array.from(new Set(r.flatMap(o=>Object.keys(o.horizonScores).map(l=>Number(l)).filter(l=>Number.isFinite(l))))).sort((o,l)=>o-l),d=Array.from(new Set(t.map(o=>o.timeframe))),p=d.map(o=>{const l=t.filter(g=>g.timeframe===o);return l.reduce((g,R)=>g+R.score.composite_error,0)/Math.max(l.length,1)}),_=Math.min(900,...r.slice(0,3).map(o=>o.equityCurve.length)),y=[-.06,-.04,-.025,-.015,-.0075,0,.0075,.015,.025,.04,.06],h=Array.from({length:y.length-1},()=>0);if(i)for(let o=0;o<i.yTrue.length;o+=1){const l=(i.yPred[o]-i.yTrue[o])/(Math.abs(i.closeRef[o])+1e-9);for(let g=0;g<y.length-1;g+=1)if(l>=y[g]&&l<y[g+1]){h[g]+=1;break}}const f={horizon_heatmap:{run_id:e,plot_id:"horizon_heatmap",title:"Error by Horizon",payload:{type:"heatmap",x:u,y:t.map(o=>`${o.symbol}:${o.timeframe}`),z:r.map(o=>u.map(l=>o.horizonScores[l]??Number.NaN))}},forecast_overlay:{run_id:e,plot_id:"forecast_overlay",title:i?`Forecast Overlay (${i.symbol}:${i.timeframe})`:"Forecast Overlay",payload:{type:"line",x:Array.from({length:Math.min(700,(i==null?void 0:i.yTrue.length)??0)},(o,l)=>l),series:i?[{name:"y_true",values:Array.from(i.yTrue.slice(0,700))},{name:"y_pred",values:Array.from(i.yPred.slice(0,700))},{name:"close_ref",values:Array.from(i.closeRef.slice(0,700))}]:[]}},novelty_pareto:{run_id:e,plot_id:"novelty_pareto",title:"Novelty/Complexity vs Accuracy",payload:{type:"scatter",points:r.flatMap(o=>o.frontier.map(l=>({label:`${o.symbol}:${o.timeframe}:${l.label}`,complexity:l.complexity,error:l.error,hit_rate:l.hitRate,pnl:o.pnl})))}},timeframe_error:{run_id:e,plot_id:"timeframe_error",title:"Composite Error by Timeframe",payload:{type:"bar",categories:d,values:p}},leaderboard:{run_id:e,plot_id:"leaderboard",title:"Asset Leaderboard",payload:{type:"table",rows:t.map(o=>({asset:`${o.symbol}:${o.timeframe}`,error:o.score.composite_error,hit_rate:o.score.directional_hit_rate,horizon:o.best_horizon,pnl:o.score.pnl_total,max_drawdown:o.score.max_drawdown,turnover:o.score.turnover,stability:o.score.stability_score}))}},equity_curve:{run_id:e,plot_id:"equity_curve",title:"Equity Curve (Top 3)",payload:{type:"line",x:Array.from({length:Math.max(0,_)},(o,l)=>l),series:r.slice(0,3).map(o=>({name:`${o.symbol}:${o.timeframe}`,values:o.equityCurve.slice(0,Math.max(0,_))}))}},residual_histogram:{run_id:e,plot_id:"residual_histogram",title:i?`Residual Distribution (${i.symbol}:${i.timeframe})`:"Residual Distribution",payload:{type:"bar",categories:y.slice(0,-1).map((o,l)=>`${o.toFixed(3)}..${y[l+1].toFixed(3)}`),values:h}}},x={};for(const o of r.slice(0,3))x[`${o.symbol}_${o.timeframe}_indicator.pine`]=`//@version=6
indicator("${o.symbol} ${o.timeframe}", overlay=false)
horizon = ${o.horizon}
value = ${o.pine}
plot(value)
`;return a?x["universal_indicator.pine"]=`//@version=6
indicator("Novel Indicator Universal", overlay=false)
horizon = ${a.horizon}
value = ${a.pine}
plot(value)
`:x["universal_indicator.pine"]=`//@version=6
indicator("Novel Indicator Universal", overlay=false)
value = close
plot(value)
`,{summary:m,plots:f,pine:x}}async function vt(e){const r=$.get(e);if(!r)return;const t=Date.now();let s=Date.now();try{E(r,"running","universe",.05,"Selecting Binance universe in browser..."),H(r,{stage:"universe",working_on:"Binance universe query",achieved:"0 symbols",remaining:"pending",overall_progress:.05,stage_progress:.2,run_elapsed_sec:0,stage_elapsed_sec:0,eta_total_sec:null,eta_stage_sec:null,rate_units_per_sec:0}),await P(e,r);const n=await _t(r,r.config.top_n_symbols),a=[],m=Math.max(1,n.length*r.config.timeframes.length);let i=0;E(r,"running","ingest",.15,`Ingesting ${n.length} symbols from Binance...`),await P(e,r);for(const d of n)for(const p of r.config.timeframes){if(I.has(e))throw new Error("Run canceled");s=Date.now(),E(r,"running","optimization",Math.min(.85,.15+i/m),`Optimizing ${d} ${p} locally...`);const _=r.config.budget_minutes/Math.max(m,1),y=p==="5m"?_<3?70:_<6?95:130:p==="1h"?_<3?260:_<6?380:620:_<3?420:_<6?730:1050,h=await bt(r,d,p,y);if(h.length>600)try{const l=wt(h,nt(r.config.random_seed,d,p));l.symbol=d,l.timeframe=p,a.push(l)}catch(l){r.run.logs.push({timestamp:A(),stage:"optimization",message:`Skipped ${d} ${p}: ${l.message}`})}else r.run.logs.push({timestamp:A(),stage:"ingest",message:`Skipped ${d} ${p}: insufficient candles (${h.length}).`});i+=1;const f=Math.max((Date.now()-t)/1e3,.1),x=f/Math.max(i,1),o=Math.max(0,m-i);H(r,{stage:"optimization",working_on:`${d} ${p}`,achieved:`${i}/${m} datasets`,remaining:`${o} datasets`,overall_progress:Math.min(.85,.15+i/m),stage_progress:i/m,run_elapsed_sec:f,stage_elapsed_sec:(Date.now()-s)/1e3,eta_total_sec:x*o,eta_stage_sec:x,rate_units_per_sec:i/f}),await P(e,r)}if(!a.length)throw new Error("No valid datasets produced results");E(r,"running","ranking",.92,"Building summary and visual diagnostics...");const u=xt(e,a);r.summary=u.summary,r.plots=u.plots,r.pineScripts=u.pine,E(r,"completed","finished",1,"Run completed fully in browser compute engine."),H(r,{stage:"finished",working_on:"Complete",achieved:"Run completed",remaining:"0",overall_progress:1,stage_progress:1,run_elapsed_sec:(Date.now()-t)/1e3,stage_elapsed_sec:(Date.now()-s)/1e3,eta_total_sec:0,eta_stage_sec:0,rate_units_per_sec:i/Math.max((Date.now()-t)/1e3,.1)}),await P(e,r)}catch(n){n.message==="Run canceled"?E(r,"canceled","finished",1,"Run canceled by user."):(r.run.error=n.message,E(r,"failed","finished",1,`Run failed: ${n.message}`)),await P(e,r)}finally{I.delete(e)}}function $t(){return Array.from($.values()).map(e=>e.run).sort((e,r)=>Date.parse(r.created_at)-Date.parse(e.created_at))}function X(e){if(!e.summary)return"<html><body><h1>No report data.</h1></body></html>";const r=e.summary.per_asset_recommendations.map(u=>`<tr><td>${u.symbol}</td><td>${u.timeframe}</td><td>${u.best_horizon}</td><td>${u.score.composite_error.toFixed(6)}</td><td>${u.score.directional_hit_rate.toFixed(3)}</td><td>${u.score.pnl_total.toFixed(4)}</td><td>${u.score.max_drawdown.toFixed(4)}</td><td>${u.score.turnover.toFixed(4)}</td><td>${u.score.stability_score.toFixed(3)}</td></tr>`).join(""),t=e.summary.per_asset_recommendations,s=t.length?t.reduce((u,d)=>u+d.score.composite_error,0)/t.length:0,n=t.length?t.reduce((u,d)=>u+d.score.directional_hit_rate,0)/t.length:0,a=t.length?t.reduce((u,d)=>u+d.score.pnl_total,0)/t.length:0,m=t.length?t.filter(u=>u.score.pnl_total>0).length/t.length:0,i=[];return n<.52&&i.push("Directional hit rate below robust threshold."),a<=0&&i.push("Average post-cost pnl is non-positive."),s>1.2&&i.push("Composite error remains elevated."),`<!doctype html>
  <html>
    <head>
      <meta charset="utf-8">
      <title>Novel Indicator Report</title>
      <style>
        :root{--ink:#122033;--muted:#455467;--line:#d8dfeb;--accent:#0b6bcb;--accent2:#d65a31}
        body{font-family:"Segoe UI",Arial,sans-serif;padding:24px;color:var(--ink)}
        h1,h2{margin:0 0 10px}
        p{margin:0 0 8px}
        .row{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:10px;margin:14px 0}
        .card{border:1px solid var(--line);border-radius:10px;padding:10px}
        .card label{display:block;color:var(--muted);font-size:12px}
        .card b{font-size:17px}
        table{width:100%;border-collapse:collapse;margin-top:14px}
        th,td{border:1px solid var(--line);padding:7px;font-size:12px;text-align:left}
        th{background:#f3f7fc}
        .pill{display:inline-block;background:#eef5ff;border:1px solid #d5e5fb;border-radius:999px;padding:4px 10px;font-size:12px;margin-right:6px}
        .warn{border:1px solid #f1c8b8;background:#fff6f1;border-radius:10px;padding:10px;margin-top:12px}
      </style>
    </head>
    <body>
      <h1>Novel Indicator Report</h1>
      <p>Run <b>${e.summary.run_id}</b> | Generated ${e.summary.generated_at}</p>
      <div class="row">
        <div class="card"><label>Avg Composite Error</label><b>${s.toFixed(5)}</b></div>
        <div class="card"><label>Avg Hit Rate</label><b>${(n*100).toFixed(2)}%</b></div>
        <div class="card"><label>Avg PnL</label><b>${a.toFixed(4)}</b></div>
        <div class="card"><label>Positive-PnL Assets</label><b>${(m*100).toFixed(1)}%</b></div>
      </div>
      <h2>Universal Recommendation</h2>
      <p>Horizon: <b>${e.summary.universal_recommendation.best_horizon}</b> bars | Composite Error: <b>${e.summary.universal_recommendation.score.composite_error.toFixed(6)}</b></p>
      <p>Hit Rate: <b>${e.summary.universal_recommendation.score.directional_hit_rate.toFixed(3)}</b> | PnL: <b>${e.summary.universal_recommendation.score.pnl_total.toFixed(4)}</b></p>
      <p>${e.summary.universal_recommendation.indicator_combo.map(u=>`<span class="pill">${u.indicator_id}</span>`).join("")}</p>
      <table>
        <thead><tr><th>Symbol</th><th>TF</th><th>Horizon</th><th>Error</th><th>Hit</th><th>PnL</th><th>MaxDD</th><th>Turnover</th><th>Stability</th></tr></thead>
        <tbody>${r}</tbody>
      </table>
      ${i.length?`<div class="warn"><b>Quality warnings</b><ul>${i.map(u=>`<li>${u}</li>`).join("")}</ul></div>`:""}
    </body>
  </html>`}function Mt(e){if(e==null)return"";const r=String(e);return/[,"\n]/.test(r)?`"${r.replace(/"/g,'""')}"`:r}function Rt(e){const r=["symbol","timeframe","best_horizon","normalized_rmse","normalized_mae","composite_error","directional_hit_rate","pnl_total","max_drawdown","turnover","stability_score","indicator_ids","indicator_expressions"],t=e.per_asset_recommendations.map(s=>{const n=s.indicator_combo.map(m=>m.indicator_id).join("|"),a=s.indicator_combo.map(m=>m.expression).join("|");return[s.symbol,s.timeframe,s.best_horizon,s.score.normalized_rmse,s.score.normalized_mae,s.score.composite_error,s.score.directional_hit_rate,s.score.pnl_total,s.score.max_drawdown,s.score.turnover,s.score.stability_score,n,a]});return[r,...t].map(s=>s.map(n=>Mt(n)).join(",")).join(`
`)}function Y(e){return e.length?`${e.map(r=>JSON.stringify(r)).join(`
`)}
`:""}function St(e){if(!e.summary)throw new Error("Run not found");const r=A(),t=[{path:"report/report.html",content:X(e),mime:"text/html;charset=utf-8"},{path:"run/run_status.json",content:JSON.stringify(e.run,null,2),mime:"application/json;charset=utf-8"},{path:"run/config.json",content:JSON.stringify(e.config,null,2),mime:"application/json;charset=utf-8"},{path:"results/summary.json",content:JSON.stringify(e.summary,null,2),mime:"application/json;charset=utf-8"},{path:"results/per_asset_recommendations.csv",content:Rt(e.summary),mime:"text/csv;charset=utf-8"}],s=Object.values(e.plots).sort((m,i)=>m.plot_id.localeCompare(i.plot_id));for(const m of s)t.push({path:`plots/${m.plot_id}.json`,content:JSON.stringify({run_id:m.run_id,plot_id:m.plot_id,title:m.title,payload:m.payload},null,2),mime:"application/json;charset=utf-8"});const n=Object.entries(e.pineScripts).sort(([m],[i])=>m.localeCompare(i));for(const[m,i]of n)t.push({path:`pine/${m}`,content:i,mime:"text/plain;charset=utf-8"});e.telemetry.length>0&&t.push({path:"telemetry/telemetry.jsonl",content:Y(e.telemetry),mime:"application/x-ndjson;charset=utf-8"}),e.binanceCalls.length>0&&t.push({path:"diagnostics/binance_calls.jsonl",content:Y(e.binanceCalls),mime:"application/x-ndjson;charset=utf-8"});const a={run_id:e.run.run_id,generated_at:r,file_count:t.length+1,files:t.map(m=>({path:m.path,mime:m.mime}))};return t.unshift({path:"manifest.json",content:JSON.stringify(a,null,2),mime:"application/json;charset=utf-8"}),{run_id:e.run.run_id,generated_at:r,files:t}}function zt(e){return{run_id:e.run.run_id,source_version:"web-local-v1",sync_state:"synced",retained_at:A(),config:e.config,summary:e.summary,plots:Object.values(e.plots).map(r=>({plot_id:r.plot_id,payload:r.payload}))}}async function At(e){var r,t,s,n,a,m,i,u,d,p,_,y,h,f,x;switch(await at(),e.method){case"init":return{ok:!0};case"createRun":{const o=Array.from($.values()).find(F=>F.run.status==="queued"||F.run.status==="running");if(o)throw new Error(`Run already active (${o.run.run_id}). Cancel or wait before starting another.`);const l={...tt,...(r=e.params)==null?void 0:r.config},g=rt(),R=st(g,l);return $.set(g,R),await P(g,R),vt(g),{run_id:g,status:"queued",created_at:R.run.created_at}}case"listRuns":return $t();case"getRun":{const o=String(((t=e.params)==null?void 0:t.runId)??""),l=$.get(o);if(!l)throw new Error("Run not found");return l.run}case"getResults":{const o=String(((s=e.params)==null?void 0:s.runId)??""),l=$.get(o);if(!(l!=null&&l.summary))throw new Error("Results not found");return l.summary}case"getPlot":{const o=String(((n=e.params)==null?void 0:n.runId)??""),l=String(((a=e.params)==null?void 0:a.plotId)??""),g=(m=$.get(o))==null?void 0:m.plots[l];if(!g)throw new Error("Plot not found");return g}case"getTelemetry":{const o=String(((i=e.params)==null?void 0:i.runId)??""),l=Number(((u=e.params)==null?void 0:u.limit)??300),g=$.get(o);if(!g)throw new Error("Run not found");return{run_id:o,snapshots:g.telemetry.slice(-Math.max(1,Math.min(2e3,l)))}}case"getBinanceDiagnostics":{const o=String(((d=e.params)==null?void 0:d.runId)??""),l=Number(((p=e.params)==null?void 0:p.limit)??40),g=$.get(o);if(!g)throw new Error("Run not found");return{run_id:o,calls:g.binanceCalls.slice(-Math.max(1,Math.min(240,l)))}}case"cancelRun":{const o=String(((_=e.params)==null?void 0:_.runId)??"");if(!$.has(o))throw new Error("Run not found");return I.add(o),{ok:!0}}case"generateReport":{const o=String(((y=e.params)==null?void 0:y.runId)??""),l=$.get(o);if(!(l!=null&&l.summary))throw new Error("Run not found");return{html:X(l)}}case"exportPine":{const o=String(((h=e.params)==null?void 0:h.runId)??""),l=$.get(o);if(!(l!=null&&l.summary))throw new Error("Run not found");return{files:l.pineScripts}}case"exportRunBundle":{const o=String(((f=e.params)==null?void 0:f.runId)??""),l=$.get(o);if(!(l!=null&&l.summary))throw new Error("Run not found");return St(l)}case"getRunStoragePayload":{const o=String(((x=e.params)==null?void 0:x.runId)??""),l=$.get(o);if(!(l!=null&&l.summary))throw new Error("Run not found");return zt(l)}default:throw new Error(`Unknown method ${e.method}`)}}self.onmessage=async e=>{const r=e.data;if(!(!(r!=null&&r.id)||!r.method))try{const t=await At(r),s={id:r.id,ok:!0,result:t};self.postMessage(s)}catch(t){const s={id:r.id,ok:!1,error:t.message};self.postMessage(s)}}})();
