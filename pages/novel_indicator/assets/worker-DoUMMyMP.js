(function(){"use strict";const At={"5m":3e5,"1h":36e5,"4h":144e5};function Z(e){return At[e]??60*1e3}function q(e,t){return Math.max(0,Math.round(t)*Z(e))}function Dt(e,t){const a=Math.max(1,Math.round(t*60*1e3)),r=Z(e);return Math.max(1,Math.round(a/r))}function ee(e){if(!Number.isFinite(e)||e<=0)return"0m";const t=Math.round(e/6e4);if(t<60)return`${t}m`;const a=t/60;if(a<48){const s=Math.round(a*10)/10;return`${s%1===0?s.toFixed(0):s.toFixed(1)}h`}const r=a/24,n=Math.round(r*10)/10;return`${n%1===0?n.toFixed(0):n.toFixed(1)}d`}function kt(e,t){const a=q(e,t);return`${t} bars (${ee(a)} @ ${e})`}function X(e,t){const a=new Float64Array(e.length);let r=0;for(let n=0;n<e.length;n+=1)r+=e[n],n>=t&&(r-=e[n-t]),a[n]=n>=t-1?r/t:e[n];return a}function ce(e){if(!e.length)return 1;let t=0;for(const r of e)t+=r;t/=e.length;let a=0;for(const r of e){const n=r-t;a+=n*n}return Math.sqrt(Math.max(a/e.length,1e-9))}function dt(e){if(!e.length)return 0;let t=0;for(const a of e)t+=a;return t/e.length}function Et(e,t){let a=0;const r=Math.min(e.length,t.length);for(let n=0;n<r;n+=1)a+=Math.abs(e[n]-t[n]);return r?a/r:9999}function Ct(e,t){let a=0;const r=Math.min(e.length,t.length);for(let n=0;n<r;n+=1){const s=e[n]-t[n];a+=s*s}return r?Math.sqrt(a/r):9999}function ht(e,t){const a=new Float64Array(e.length);a.fill(Number.NaN);for(let r=0;r<e.length-t;r+=1)a[r]=e[r+t];return a}function me(e,t,a){return Math.max(t,Math.min(a,e))}function Qe(e,t){const a=new Float64Array(e.length),r=new Float64Array(e.length+1),n=new Float64Array(e.length+1);for(let s=0;s<e.length;s+=1)r[s+1]=r[s]+e[s],n[s+1]=n[s]+e[s]*e[s];for(let s=0;s<e.length;s+=1){const m=Math.max(0,s-t+1),h=s-m+1,l=r[s+1]-r[m],u=n[s+1]-n[m],z=l/h;a[s]=Math.sqrt(Math.max(u/h-z*z,0))}return a}function de(e,t){const a=new Float64Array(e.length);if(!e.length)return a;const r=2/(t+1);a[0]=e[0];for(let n=1;n<e.length;n+=1)a[n]=r*e[n]+(1-r)*a[n-1];return a}function jt(e,t){const a=new Float64Array(e.length),r=new Float64Array(e.length);for(let h=1;h<e.length;h+=1){const l=e[h]-e[h-1];l>0?a[h]=l:r[h]=-l}const n=de(a,t),s=de(r,t),m=new Float64Array(e.length);for(let h=0;h<e.length;h+=1){const l=n[h]/(s[h]+1e-9);m[h]=100-100/(1+l)}return m}function ut(e,t,a){let r=0,n=0,s=0,m=0,h=0;for(let y=0;y<a.length;y+=1){const i=a[y],c=e[i],f=t[i];!Number.isFinite(c)||!Number.isFinite(f)||(r+=c,n+=f,s+=c*c,m+=c*f,h+=1)}if(h<80)return null;const l=r/h,u=n/h,z=s-r*l;if(Math.abs(z)<1e-9)return null;const b=(m-r*u)/z;return{alpha:u-b*l,beta:b}}function _t(e,t,a,r){const n=Math.min(e.length,t.length,a.length);if(n<5)return{pnl:0,maxDrawdown:0,turnover:0,equity:[]};const s=.0012,m=new Float64Array(n);for(let g=0;g<n;g+=1){const y=(t[g]-a[g])/(a[g]+1e-9);y>r?m[g]=1:y<-r?m[g]=-1:m[g]=0}const h=new Float64Array(n);let l=0,u=1,z=1,p=0;const b=[];for(let g=0;g<n;g+=1){const y=g>0?m[g-1]:0,i=Math.abs(m[g]-y);l+=i;const c=(e[g]-a[g])/(a[g]+1e-9),f=y*c-s*i;h[g]=f,u*=1+f,u>z&&(z=u);const E=(u-z)/(z+1e-12);E<p&&(p=E),b.push(u)}return{pnl:u-1,maxDrawdown:p,turnover:l/n,equity:b}}function Pt(){return new Date().toISOString()}function pt(e){if(e==null)return"";const t=String(e);return/[,"\n]/.test(t)?`"${t.replace(/"/g,'""')}"`:t}function Ve(e){return e.length?`${e.map(t=>JSON.stringify(t)).join(`
`)}
`:""}function Bt(e){const t=["symbol","timeframe","best_horizon","best_horizon_label","normalized_rmse","normalized_mae","calibration_error","composite_error","directional_hit_rate","pnl_total","max_drawdown","turnover","stability_score","indicator_ids","indicator_expressions"],a=e.per_asset_recommendations.map(r=>{const n=r.indicator_combo.map(m=>m.indicator_id).join("|"),s=r.indicator_combo.map(m=>m.expression).join("|");return[r.symbol,r.timeframe,r.best_horizon,r.best_horizon_label??`${r.best_horizon} bars (${ee(r.best_horizon_ms??q(r.timeframe,r.best_horizon))} @ ${r.timeframe})`,r.score.normalized_rmse,r.score.normalized_mae,r.score.calibration_error??0,r.score.composite_error,r.score.directional_hit_rate,r.score.pnl_total,r.score.max_drawdown,r.score.turnover,r.score.stability_score,n,s]});return[t,...a].map(r=>r.map(n=>pt(n)).join(",")).join(`
`)}function Tt(e){const t=e.indicator_cube??[];if(!t.length)return"";const a=["symbol","timeframe","indicator_id","family","formula","novelty_score","complexity","horizon_bar","horizon_time_ms","normalized_rmse","normalized_mae","calibration_error","composite_error","directional_hit_rate","pnl_total","max_drawdown","turnover","stability_score"],r=t.map(n=>[n.symbol,n.timeframe,n.indicator_id,n.family,n.expression,n.novelty_score,n.complexity,n.horizon_bar,n.horizon_time_ms,n.normalized_rmse,n.normalized_mae,n.calibration_error,n.composite_error,n.directional_hit_rate,n.pnl_total,n.max_drawdown,n.turnover,n.stability_score]);return[a,...r].map(n=>n.map(s=>pt(s)).join(",")).join(`
`)}function ft(e){if(!e.summary)return"<html><body><h1>No report data.</h1></body></html>";const t=e.summary.per_asset_recommendations.map(u=>`<tr><td>${u.symbol}</td><td>${u.timeframe}</td><td>${u.best_horizon_label??`${u.best_horizon} bars (${ee(u.best_horizon_ms??q(u.timeframe,u.best_horizon))} @ ${u.timeframe})`}</td><td>${u.score.composite_error.toFixed(6)}</td><td>${(u.score.calibration_error??0).toFixed(6)}</td><td>${u.score.directional_hit_rate.toFixed(3)}</td><td>${u.score.pnl_total.toFixed(4)}</td><td>${u.score.max_drawdown.toFixed(4)}</td><td>${u.score.turnover.toFixed(4)}</td><td>${u.score.stability_score.toFixed(3)}</td></tr>`).join(""),a=e.summary.per_asset_recommendations,r=a.length?a.reduce((u,z)=>u+z.score.composite_error,0)/a.length:0,n=a.length?a.reduce((u,z)=>u+z.score.directional_hit_rate,0)/a.length:0,s=a.length?a.reduce((u,z)=>u+z.score.pnl_total,0)/a.length:0,m=a.length?a.reduce((u,z)=>u+(z.score.calibration_error??0),0)/a.length:0,h=a.length?a.filter(u=>u.score.pnl_total>0).length/a.length:0,l=[];return n<.52&&l.push("Directional hit rate below robust threshold."),s<=0&&l.push("Average post-cost pnl is non-positive."),r>1.2&&l.push("Composite error remains elevated."),`<!doctype html>
  <html>
    <head>
      <meta charset="utf-8">
      <title>Novel Indicator Report</title>
      <style>
        :root{--ink:#122033;--muted:#455467;--line:#d8dfeb;--accent:#0b6bcb;--accent2:#d65a31}
        body{font-family:"Segoe UI",Arial,sans-serif;padding:24px;color:var(--ink)}
        h1,h2{margin:0 0 10px}
        p{margin:0 0 8px}
        .row{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:10px;margin:14px 0}
        .card{border:1px solid var(--line);border-radius:10px;padding:10px}
        .card label{display:block;color:var(--muted);font-size:12px}
        .card b{font-size:17px}
        table{width:100%;border-collapse:collapse;margin-top:14px}
        th,td{border:1px solid var(--line);padding:7px;font-size:12px;text-align:left}
        th{background:#f3f7fc}
        .pill{display:inline-block;background:#eef5ff;border:1px solid #d5e5fb;border-radius:999px;padding:4px 10px;font-size:12px;margin-right:6px}
        .warn{border:1px solid #f1c8b8;background:#fff6f1;border-radius:10px;padding:10px;margin-top:12px}
      </style>
    </head>
    <body>
      <h1>Novel Indicator Report</h1>
      <p>Run <b>${e.summary.run_id}</b> | Generated ${e.summary.generated_at}</p>
      <div class="row">
        <div class="card"><label>Avg Composite Error</label><b>${r.toFixed(5)}</b></div>
        <div class="card"><label>Avg Calibration Error</label><b>${m.toFixed(5)}</b></div>
        <div class="card"><label>Avg Hit Rate</label><b>${(n*100).toFixed(2)}%</b></div>
        <div class="card"><label>Avg PnL</label><b>${s.toFixed(4)}</b></div>
        <div class="card"><label>Positive-PnL Assets</label><b>${(h*100).toFixed(1)}%</b></div>
      </div>
      <h2>Universal Recommendation</h2>
      <p>Horizon: <b>${e.summary.universal_recommendation.best_horizon_label??`${e.summary.universal_recommendation.best_horizon} bars (${ee(e.summary.universal_recommendation.best_horizon_ms??q(e.summary.universal_recommendation.timeframe.split("|")[0]??"1h",e.summary.universal_recommendation.best_horizon))})`}</b> | Composite Error: <b>${e.summary.universal_recommendation.score.composite_error.toFixed(6)}</b></p>
      <p>Forecast semantics: horizon bars are translated into wall-clock time by source timeframe.</p>
      <p>Hit Rate: <b>${e.summary.universal_recommendation.score.directional_hit_rate.toFixed(3)}</b> | PnL: <b>${e.summary.universal_recommendation.score.pnl_total.toFixed(4)}</b></p>
      <p>${e.summary.universal_recommendation.indicator_combo.map(u=>`<span class="pill">${u.indicator_id}</span>`).join("")}</p>
      <table>
        <thead><tr><th>Symbol</th><th>TF</th><th>Horizon (bars/time)</th><th>Error</th><th>Calibration</th><th>Hit</th><th>PnL</th><th>MaxDD</th><th>Turnover</th><th>Stability</th></tr></thead>
        <tbody>${t}</tbody>
      </table>
      ${e.summary.validation_report?`<h2>Validation and Bias Checks</h2>
      <p>Leakage checks passed: <b>${e.summary.validation_report.leakage_checks_passed?"yes":"no"}</b> | Leakage sentinel triggered: <b>${e.summary.validation_report.leakage_sentinel_triggered?"yes":"no"}</b></p>
      <p>Holdout rows: <b>${e.summary.validation_report.holdout_rows}</b> | Holdout pass ratio: <b>${(e.summary.validation_report.holdout_pass_ratio*100).toFixed(2)}%</b> | Baseline rejection rate: <b>${(e.summary.validation_report.baseline_rejection_rate*100).toFixed(2)}%</b></p>
      ${e.summary.validation_report.warnings.length?`<div class="warn"><b>Validation warnings</b><ul>${e.summary.validation_report.warnings.slice(0,12).map(u=>`<li>${u}</li>`).join("")}</ul></div>`:""}`:""}
      ${l.length?`<div class="warn"><b>Quality warnings</b><ul>${l.map(u=>`<li>${u}</li>`).join("")}</ul></div>`:""}
    </body>
  </html>`}function It(e){if(!e.summary)throw new Error("Run not found");const t=Pt(),a=[{path:"report/report.html",content:ft(e),mime:"text/html;charset=utf-8"},{path:"run/run_status.json",content:JSON.stringify(e.run,null,2),mime:"application/json;charset=utf-8"},{path:"run/config.json",content:JSON.stringify(e.config,null,2),mime:"application/json;charset=utf-8"},{path:"results/summary.json",content:JSON.stringify(e.summary,null,2),mime:"application/json;charset=utf-8"},{path:"results/per_asset_recommendations.csv",content:Bt(e.summary),mime:"text/csv;charset=utf-8"}];(e.summary.indicator_cube??[]).length>0&&(a.push({path:"results/indicator_cube.csv",content:Tt(e.summary),mime:"text/csv;charset=utf-8"}),a.push({path:"results/indicator_cube.jsonl",content:Ve(e.summary.indicator_cube??[]),mime:"application/x-ndjson;charset=utf-8"}));const r=Object.values(e.plots).sort((m,h)=>m.plot_id.localeCompare(h.plot_id));for(const m of r)a.push({path:`plots/${m.plot_id}.json`,content:JSON.stringify({run_id:m.run_id,plot_id:m.plot_id,title:m.title,payload:m.payload},null,2),mime:"application/json;charset=utf-8"});const n=Object.entries(e.pineScripts).sort(([m],[h])=>m.localeCompare(h));for(const[m,h]of n)a.push({path:`pine/${m}`,content:h,mime:"text/plain;charset=utf-8"});e.telemetry.length>0&&a.push({path:"telemetry/telemetry.jsonl",content:Ve(e.telemetry),mime:"application/x-ndjson;charset=utf-8"}),e.binanceCalls.length>0&&a.push({path:"diagnostics/binance_calls.jsonl",content:Ve(e.binanceCalls),mime:"application/x-ndjson;charset=utf-8"});const s={run_id:e.run.run_id,generated_at:t,file_count:a.length+1,files:a.map(m=>({path:m.path,mime:m.mime}))};return a.unshift({path:"manifest.json",content:JSON.stringify(s,null,2),mime:"application/json;charset=utf-8"}),{run_id:e.run.run_id,generated_at:t,files:a}}const Ht="novel-indicator-browser-db",Ot=2,he="runs",ue="klines";let Ee=null;function Ce(){return Ee||(Ee=new Promise((e,t)=>{const a=indexedDB.open(Ht,Ot);a.onupgradeneeded=()=>{const r=a.result;r.objectStoreNames.contains(he)||r.createObjectStore(he,{keyPath:"id"}),r.objectStoreNames.contains(ue)||r.createObjectStore(ue,{keyPath:"key"})},a.onsuccess=()=>e(a.result),a.onerror=()=>t(a.error??new Error("IDB open error"))}),Ee)}async function Lt(e,t){const a=await Ce();await new Promise((r,n)=>{const s=a.transaction(he,"readwrite");s.objectStore(he).put(t),s.oncomplete=()=>r(),s.onerror=()=>n(s.error??new Error("IDB write error"))})}async function Ut(){const e=await Ce();return await new Promise((t,a)=>{const n=e.transaction(he,"readonly").objectStore(he).getAll();n.onsuccess=()=>t(n.result??[]),n.onerror=()=>a(n.error??new Error("IDB read error"))})}async function Jt(e){const t=await Ce();return await new Promise((a,r)=>{const s=t.transaction(ue,"readonly").objectStore(ue).get(e);s.onsuccess=()=>a(s.result??null),s.onerror=()=>r(s.error??new Error("IDB read error"))})}async function Kt(e,t,a){const r=await Ce();await new Promise((n,s)=>{const m=r.transaction(ue,"readwrite");m.objectStore(ue).put({key:e,fetched_at:t,rows:a}),m.oncomplete=()=>n(),m.onerror=()=>s(m.error??new Error("IDB write error"))})}const D={top_n_symbols:4,timeframes:["5m","1h"],budget_minutes:8,random_seed:42,advanced:{horizon:{min_bar:3,max_bar:180,coarse_step:12,refine_radius:8},search:{candidate_pool_size:140,stage_a_keep:60,stage_b_keep:20,tuning_trials:4,max_combo_size:3,novelty_similarity_threshold:.8,collinearity_threshold:.92,min_novelty_score:.2},validation:{folds:4,embargo_bars:8,purge_bars:8,search_split:.58,model_select_split:.22,holdout_split:.2,baseline_margin:.015},objective_weights:{rmse:.37,mae:.3,calibration:.18,directional:.15}}},Wt=1200*1e3;let bt=!1;const O=new Map,Ze=new Set,je=new Map;let xe=null;function Y(){return new Date().toISOString()}function Gt(){return crypto.randomUUID().replace(/-/g,"").slice(0,12)}function Xt(e){const t=JSON.stringify(e);let a=2166136261;for(let r=0;r<t.length;r+=1)a^=t.charCodeAt(r),a=Math.imul(a,16777619);return`cfg_${(a>>>0).toString(16)}`}function Yt(e,t,a){const r=`${t}:${a}`;let n=2166136261;for(let s=0;s<r.length;s+=1)n^=r.charCodeAt(s),n=Math.imul(n,16777619);return e+(n>>>0)>>>0}function I(e,t,a){return Number.isFinite(e)?Math.min(a,Math.max(t,Math.round(e))):t}function qt(e){const t=Math.max(.01,e.rmse),a=Math.max(.01,e.mae),r=Math.max(.01,e.calibration),n=Math.max(.01,e.directional),s=t+a+r+n;return{rmse:t/s,mae:a/s,calibration:r/s,directional:n/s}}function et(e){var n,s,m,h,l,u,z,p,b,g,y,i,c,f,E,B,H,U,L,ae,Q,j,G,Me,Pe,$e,Ne,Be,Se,Te,oe,pe,fe,Ie,He,Oe,Re,be,Fe,Ae,V,ge,ye,De,Le,re,Ue,ve,Je,Ke;const t=e??{},a=t.advanced??{},r={top_n_symbols:I(Number(t.top_n_symbols??D.top_n_symbols),1,30),timeframes:Array.isArray(t.timeframes)?t.timeframes.filter(We=>typeof We=="string"&&["5m","1h","4h"].includes(We)):[...D.timeframes],budget_minutes:I(Number(t.budget_minutes??D.budget_minutes),5,240),seed_mode:t.seed_mode==="manual"?"manual":"auto",random_seed:I(Number(t.random_seed??D.random_seed??42),1,1e6),advanced:{performance_profile:a.performance_profile==="deep"||a.performance_profile==="balanced"?a.performance_profile:"fast",horizon:{min_bar:I(Number(((n=a.horizon)==null?void 0:n.min_bar)??((s=D.advanced)==null?void 0:s.horizon.min_bar)??3),1,400),max_bar:I(Number(((m=a.horizon)==null?void 0:m.max_bar)??((h=D.advanced)==null?void 0:h.horizon.max_bar)??180),2,600),coarse_step:I(Number(((l=a.horizon)==null?void 0:l.coarse_step)??((u=D.advanced)==null?void 0:u.horizon.coarse_step)??12),1,80),refine_radius:I(Number(((z=a.horizon)==null?void 0:z.refine_radius)??((p=D.advanced)==null?void 0:p.horizon.refine_radius)??8),1,40)},search:{candidate_pool_size:I(Number(((b=a.search)==null?void 0:b.candidate_pool_size)??((g=D.advanced)==null?void 0:g.search.candidate_pool_size)??140),32,500),stage_a_keep:I(Number(((y=a.search)==null?void 0:y.stage_a_keep)??((i=D.advanced)==null?void 0:i.search.stage_a_keep)??60),8,300),stage_b_keep:I(Number(((c=a.search)==null?void 0:c.stage_b_keep)??((f=D.advanced)==null?void 0:f.search.stage_b_keep)??20),4,160),tuning_trials:I(Number(((E=a.search)==null?void 0:E.tuning_trials)??((B=D.advanced)==null?void 0:B.search.tuning_trials)??4),1,16),max_combo_size:I(Number(((H=a.search)==null?void 0:H.max_combo_size)??((U=D.advanced)==null?void 0:U.search.max_combo_size)??3),1,6),novelty_similarity_threshold:Math.min(.98,Math.max(.4,Number(((L=a.search)==null?void 0:L.novelty_similarity_threshold)??((ae=D.advanced)==null?void 0:ae.search.novelty_similarity_threshold)??.8))),collinearity_threshold:Math.min(.995,Math.max(.65,Number(((Q=a.search)==null?void 0:Q.collinearity_threshold)??((j=D.advanced)==null?void 0:j.search.collinearity_threshold)??.92))),min_novelty_score:Math.min(1,Math.max(0,Number(((G=a.search)==null?void 0:G.min_novelty_score)??((Me=D.advanced)==null?void 0:Me.search.min_novelty_score)??.2)))},validation:{folds:I(Number(((Pe=a.validation)==null?void 0:Pe.folds)??(($e=D.advanced)==null?void 0:$e.validation.folds)??4),2,6),embargo_bars:I(Number(((Ne=a.validation)==null?void 0:Ne.embargo_bars)??((Be=D.advanced)==null?void 0:Be.validation.embargo_bars)??8),0,64),purge_bars:I(Number(((Se=a.validation)==null?void 0:Se.purge_bars)??((Te=D.advanced)==null?void 0:Te.validation.purge_bars)??8),0,64),search_split:Math.min(.75,Math.max(.35,Number(((oe=a.validation)==null?void 0:oe.search_split)??((pe=D.advanced)==null?void 0:pe.validation.search_split)??.58))),model_select_split:Math.min(.4,Math.max(.1,Number(((fe=a.validation)==null?void 0:fe.model_select_split)??((Ie=D.advanced)==null?void 0:Ie.validation.model_select_split)??.22))),holdout_split:Math.min(.35,Math.max(.1,Number(((He=a.validation)==null?void 0:He.holdout_split)??((Oe=D.advanced)==null?void 0:Oe.validation.holdout_split)??.2))),baseline_margin:Math.min(.2,Math.max(0,Number(((Re=a.validation)==null?void 0:Re.baseline_margin)??((be=D.advanced)==null?void 0:be.validation.baseline_margin)??.015)))},objective_weights:qt({rmse:Number(((Fe=a.objective_weights)==null?void 0:Fe.rmse)??((Ae=D.advanced)==null?void 0:Ae.objective_weights.rmse)??.37),mae:Number(((V=a.objective_weights)==null?void 0:V.mae)??((ge=D.advanced)==null?void 0:ge.objective_weights.mae)??.3),calibration:Number(((ye=a.objective_weights)==null?void 0:ye.calibration)??((De=D.advanced)==null?void 0:De.objective_weights.calibration)??.18),directional:Number(((Le=a.objective_weights)==null?void 0:Le.directional)??((re=D.advanced)==null?void 0:re.objective_weights.directional)??.15)})}};return r.timeframes.length===0&&(r.timeframes=[...D.timeframes]),(((Ue=r.advanced)==null?void 0:Ue.horizon.max_bar)??2)<=(((ve=r.advanced)==null?void 0:ve.horizon.min_bar)??1)&&(r.advanced.horizon.max_bar=r.advanced.horizon.min_bar+1),(((Je=r.advanced)==null?void 0:Je.search.stage_b_keep)??4)>(((Ke=r.advanced)==null?void 0:Ke.search.stage_a_keep)??8)&&(r.advanced.search.stage_b_keep=r.advanced.search.stage_a_keep),r.seed_mode==="auto"&&(r.random_seed=D.random_seed),r}async function gt(e,t){await Lt(e,{id:e,bundle:t})}function we(e,t){je.set(e,t),xe===null&&(xe=self.setTimeout(()=>{tt()},1e3))}async function tt(){if(xe!==null&&(self.clearTimeout(xe),xe=null),je.size===0)return;const e=Array.from(je.entries());je.clear(),await Promise.all(e.map(([t,a])=>gt(t,a)))}async function Qt(){if(bt)return;const e=await Ut();for(const t of e)if(t!=null&&t.id&&t.bundle){const a=t.bundle;a.config=et(a.config),a.context=a.context??{},O.set(t.id,a)}bt=!0}async function Vt(e,t,a){const r=`${e}|${t}|${a}`,n=await Jt(r);return!n||Date.now()-n.fetched_at>Wt?null:n.rows}async function Zt(e,t,a,r){const n=`${e}|${t}|${a}`;await Kt(n,Date.now(),r)}function ea(e,t){const a=Y();return{run:{run_id:e,status:"queued",stage:"created",progress:0,created_at:a,updated_at:a,config_hash:Xt(t),logs:[{timestamp:a,stage:"created",message:"Run created in browser engine."}]},config:et(t),summary:null,plots:{},telemetry:[],binanceCalls:[],pineScripts:{}}}function te(e,t,a,r,n){e.run.status=t,e.run.stage=a,e.run.progress=Math.max(0,Math.min(1,r)),e.run.updated_at=Y(),e.run.logs.push({timestamp:e.run.updated_at,stage:a,message:n}),e.run.logs.length>300&&(e.run.logs=e.run.logs.slice(-300))}function at(e,t){const a=performance.memory;e.telemetry.push({...t,ts:Y(),logical_cores:typeof navigator<"u"?navigator.hardwareConcurrency:null,device_memory_gb:typeof navigator<"u"?navigator.deviceMemory??null:null,js_heap_used_mb:a?a.usedJSHeapSize/(1024*1024):null,js_heap_limit_mb:a?a.jsHeapSizeLimit/(1024*1024):null,js_heap_percent:a?a.usedJSHeapSize/Math.max(a.jsHeapSizeLimit,1)*100:null,worker_busy_ratio:Math.max(0,Math.min(1,t.rate_units_per_sec/30)),storage_used_mb:JSON.stringify(e).length/(1024*1024)}),e.telemetry.length>1200&&(e.telemetry=e.telemetry.slice(-1200))}function ta(e){let t=e>>>0;return()=>{t+=1831565813;let a=t;return a=Math.imul(a^a>>>15,a|1),a^=a+Math.imul(a^a>>>7,a|61),((a^a>>>14)>>>0)/4294967296}}function aa(e,t,a){const r=["x-mbx-used-weight","x-mbx-used-weight-1m","x-mbx-order-count-10s","x-mbx-order-count-1m","date","content-type"],n={};for(const s of r){const m=a.headers.get(s);m!==null&&(n[s]=m)}e.binanceCalls.push({ts:Y(),endpoint:t,status:a.status,headers:n}),e.binanceCalls.length>240&&(e.binanceCalls=e.binanceCalls.slice(-240))}async function yt(e,t,a,r=4){let n=null;for(let s=0;s<r;s+=1)try{const m=await fetch(a);if(aa(e,t,m),m.status===429||m.status>=500){const h=350*Math.pow(2,s)+Math.floor(Math.random()*140);await new Promise(l=>setTimeout(l,h));continue}return m}catch(m){n=m;const h=350*Math.pow(2,s)+Math.floor(Math.random()*140);await new Promise(l=>setTimeout(l,h))}throw n||new Error(`Binance request failed: ${t}`)}async function oa(e,t){const a=await yt(e,"/api/v3/ticker/24hr","https://api.binance.com/api/v3/ticker/24hr");if(!a.ok)throw new Error(`Binance universe request failed (${a.status})`);const r=await a.json(),n=new Set(["USDC","USDT","FDUSD","BUSD","TUSD","DAI","USDP","EUR","GBP"]);return r.filter(s=>s.symbol.endsWith("USDT")).filter(s=>!/(UP|DOWN|BULL|BEAR)/.test(s.symbol)).filter(s=>!n.has(s.symbol.slice(0,-4))).map(s=>{const m=Number(s.quoteVolume||"0"),h=Math.abs(Number(s.priceChangePercent||"0")),l=Number(s.count??0),u=Math.log10(m+1)*me(h/5,.2,2.2)*me(Math.log10(l+10)/4,.3,1.6);return{symbol:s.symbol,score:u}}).sort((s,m)=>m.score-s.score).slice(0,t).map(s=>s.symbol)}async function ra(e,t,a,r){const n=await Vt(t,a,r);if(n&&n.length>0)return n;const s=Date.now(),m=s-r*24*60*60*1e3,h=Z(a);let l=m;const u=[];for(;l<s;){const z=new URLSearchParams({symbol:t,interval:a,startTime:String(l),endTime:String(s),limit:"1000"}),p=await yt(e,"/api/v3/klines",`https://api.binance.com/api/v3/klines?${z.toString()}`);if(!p.ok)throw new Error(`Binance klines failed (${p.status})`);const b=await p.json();if(!b.length)break;for(const y of b)u.push({timestamp:Number(y[0]),open:Number(y[1]),high:Number(y[2]),low:Number(y[3]),close:Number(y[4]),volume:Number(y[5])});const g=Number(b[b.length-1][0])+h;if(g<=l||(l=g,b.length<1e3))break}return u.sort((z,p)=>z.timestamp-p.timestamp),u.length>0&&await Zt(t,a,r,u),u}function na(e,t,a,r){var zt,Mt,$t,Nt;const n=((zt=a.advanced)==null?void 0:zt.objective_weights)??D.advanced.objective_weights,s=((Mt=a.advanced)==null?void 0:Mt.horizon)??D.advanced.horizon,m=(($t=a.advanced)==null?void 0:$t.search)??D.advanced.search,h=((Nt=a.advanced)==null?void 0:Nt.validation)??D.advanced.validation,l=Float64Array.from(e.map(o=>o.close)),u=Float64Array.from(e.map(o=>o.open)),z=Float64Array.from(e.map(o=>o.high)),p=Float64Array.from(e.map(o=>o.low)),b=Float64Array.from(e.map(o=>o.volume)),g=Float64Array.from(e.map(o=>o.timestamp));for(let o=1;o<e.length;o+=1)if(!(e[o].timestamp>e[o-1].timestamp))throw new Error("Input timestamps must be strictly increasing");const y=ta(t),i=[],c=[5,8,13,21,34,55],f=["ret1(close)","sub(ema(close,12),ema(close,26))","div(sub(close,sma(close,20)),std(close,20))","rsi(close,14)"],E=o=>new Set((o.match(/[A-Za-z0-9_]+/g)??[]).map(d=>d.toLowerCase())),B=(o,d)=>{const _=E(o),w=E(d);if(_.size===0&&w.size===0)return 1;const F=new Set([..._,...w]);let x=0;return _.forEach(v=>{w.has(v)&&(x+=1)}),x/Math.max(F.size,1)},H=(o,d)=>{const _=Math.min(o.length,d.length);if(_<12)return 0;let w=0,F=0;for(let k=0;k<_;k+=1)w+=o[k],F+=d[k];w/=_,F/=_;let x=0,v=0,N=0;for(let k=0;k<_;k+=1){const P=o[k]-w,M=d[k]-F;x+=P*M,v+=P*P,N+=M*M}return Math.abs(x/Math.sqrt(Math.max(v*N,1e-12)))},U=o=>{const d=new Float64Array(o.length);let _=0;for(let w=0;w<o.length;w+=1){const F=o[w];if(!Number.isFinite(F)){d[w]=_;continue}const x=me(F,-50,50);d[w]=x,_=x}return d},L=(o,d,_,w)=>{if(o.length<3)return{normalizedRmse:9999,normalizedMae:9999,calibration:9999,composite:9999,hitRate:0,pnl:0,maxDrawdown:0,turnover:0,stability:0};const F=Ct(o,d)/(ce(o)+1e-9);let x=0;const v=new Float64Array(o.length),N=new Float64Array(o.length);for(let T=0;T<o.length;T+=1){const se=(o[T]-_[T])/(_[T]+1e-9),Xe=(d[T]-_[T])/(_[T]+1e-9);N[T]=se,v[T]=Xe,x+=Math.abs(se)}const k=Et(o,d)/(x/o.length+1e-9);let P=0;for(let T=0;T<o.length;T+=1)Math.sign(N[T])===Math.sign(v[T])&&(P+=1);const M=o.length?P/o.length:0,$=Math.abs(dt(v)-dt(N))+Math.abs(ce(v)-ce(N)),C=n.rmse*F+n.mae*k+n.calibration*$+n.directional*(1-M),A=_t(o,d,_,.001),S=1/(ce(Float64Array.from(w))+1e-6);return{normalizedRmse:F,normalizedMae:k,calibration:$,composite:C,hitRate:M,pnl:A.pnl,maxDrawdown:A.maxDrawdown,turnover:A.turnover,stability:S}},ae=(o,d,_,w,F,x,v)=>{const N=l.slice(d,_),k=o.slice(d,_),P=ht(N,w),M=N.length-w-1;if(M<220)return null;const $=Math.floor(M/(F+1));if($<45)return null;const C=new Float64Array(N.length);C.fill(Number.NaN);for(let W=0;W<N.length;W+=1)Number.isFinite(P[W])&&(C[W]=(P[W]-N[W])/(N[W]+1e-9));const A=[],S=[],T=[],se=[],Xe=[];for(let W=0;W<F;W+=1){const St=$*(W+1),Ye=St+v,_a=Math.min(Ye+$,M),Rt=Math.max(0,St-x-w);if(Ye<=Rt)continue;const nt=Math.max(0,Rt),it=Math.max(0,_a-Ye);if(nt<80||it<25)continue;const Ft=new Int32Array(nt);for(let K=0;K<nt;K+=1)Ft[K]=K;const st=new Int32Array(it);for(let K=0;K<it;K+=1)st[K]=Ye+K;const lt=ut(k,C,Ft);if(!lt)continue;const qe=[],ct=[],mt=[];for(let K=0;K<st.length;K+=1){const le=st[K];if(!Number.isFinite(k[le])||!Number.isFinite(P[le]))continue;const fa=me(lt.alpha+lt.beta*k[le],-.8,.8),ba=N[le]*(1+fa);qe.push(P[le]),ct.push(ba),mt.push(N[le]),se.push(g[d+le]??0)}if(qe.length<10)continue;const pa=L(Float64Array.from(qe),Float64Array.from(ct),Float64Array.from(mt),[]);Xe.push(pa.composite),A.push(...qe),S.push(...ct),T.push(...mt)}return A.length<40?null:{yTrue:Float64Array.from(A),yPred:Float64Array.from(S),closeRef:Float64Array.from(T),timestamps:Float64Array.from(se),foldErrors:Xe}},Q=(o,d,_,w)=>{const F=ht(l,d),x=new Float64Array(l.length);x.fill(Number.NaN);for(let S=0;S<l.length;S+=1)Number.isFinite(F[S])&&(x[S]=(F[S]-l[S])/(l[S]+1e-9));const v=Math.max(0,_-w-d),N=l.length-d-1;if(v<120||N-_<40)return null;const k=new Int32Array(v);for(let S=0;S<v;S+=1)k[S]=S;const P=ut(o,x,k);if(!P)return null;const M=[],$=[],C=[],A=[];for(let S=_;S<N;S+=1){if(!Number.isFinite(o[S])||!Number.isFinite(F[S]))continue;const T=me(P.alpha+P.beta*o[S],-.8,.8),se=l[S]*(1+T);M.push(F[S]),$.push(se),C.push(l[S]),A.push(g[S])}return M.length<40?null:{yTrue:Float64Array.from(M),yPred:Float64Array.from($),closeRef:Float64Array.from(C),timestamps:Float64Array.from(A)}},j=o=>{if(i.some(_=>_.id===o.id))return;const d=U(o.feature);ce(d)<1e-8||i.push({...o,feature:d,novelty:0})},G=new Float64Array(l.length);for(let o=1;o<l.length;o+=1)G[o]=(l[o]-l[o-1])/(l[o-1]+1e-9);j({id:"cand_ret1",expr:"ret1(close)",pine:"(close - close[1]) / (close[1] + 1e-9)",family:"regime_state",complexity:2,feature:G});const Me=new Float64Array(l.length);for(let o=3;o<l.length;o+=1)Me[o]=(l[o]-l[o-3])/(l[o-3]+1e-9);j({id:"cand_ret3",expr:"ret3(close)",pine:"(close - close[3]) / (close[3] + 1e-9)",family:"regime_state",complexity:2,feature:Me});for(const o of c){const d=X(l,o),_=new Float64Array(l.length);for(let w=0;w<l.length;w+=1)_[w]=l[w]/(d[w]+1e-9)-1;j({id:`cand_sma_${o}`,expr:`div(close,sma(close,${o}))`,pine:`close / (ta.sma(close, ${o}) + 1e-9)`,family:"trend_curvature",complexity:4,feature:_})}const Pe=de(l,8),$e=de(l,21),Ne=new Float64Array(l.length);for(let o=0;o<l.length;o+=1)Ne[o]=(Pe[o]-$e[o])/(Math.abs($e[o])+1e-9);j({id:"cand_ema_gap",expr:"div(sub(ema(close,8),ema(close,21)),abs(ema(close,21)))",pine:"(ta.ema(close, 8) - ta.ema(close, 21)) / (math.abs(ta.ema(close, 21)) + 1e-9)",family:"trend_curvature",complexity:5,feature:Ne});const Be=jt(l,14),Se=new Float64Array(l.length);for(let o=0;o<l.length;o+=1)Se[o]=(Be[o]-50)/50;j({id:"cand_rsi14",expr:"sub(rsi(close,14),50)",pine:"(ta.rsi(close, 14) - 50) / 50",family:"regime_state",complexity:4,feature:Se});const Te=Qe(G,20);j({id:"cand_ret_std20",expr:"std(ret1(close),20)",pine:"ta.stdev((close-close[1])/(close[1]+1e-9), 20)",family:"volatility_state",complexity:4,feature:Te});const oe=new Float64Array(l.length),pe=new Float64Array(l.length),fe=new Float64Array(l.length);for(let o=0;o<l.length;o+=1){oe[o]=z[o]-p[o],pe[o]=oe[o]/(Math.abs(l[o])+1e-9);const d=Math.max(oe[o],1e-9),_=z[o]-Math.max(u[o],l[o]),w=Math.min(u[o],l[o])-p[o];fe[o]=(_-w)/d}const Ie=Math.max(36,m.candidate_pool_size),He=Math.max(24,Ie-i.length);for(let o=0;o<He;o+=1){const d=o%5,_=c[Math.floor(y()*c.length)],w=c[Math.floor(y()*c.length)],F=c[Math.floor(y()*c.length)],x=Math.min(_,w),v=Math.max(_,w);if(d===0){const M=X(l,x),$=X(l,v),C=new Float64Array(l.length);for(let A=0;A<l.length;A+=1)C[A]=(M[A]-$[A])/(Math.abs($[A])+1e-9);j({id:`cand_cross_${o}_${x}_${v}`,expr:`div(sub(sma(close,${x}),sma(close,${v})),abs(sma(close,${v})))`,pine:`(ta.sma(close, ${x}) - ta.sma(close, ${v})) / (math.abs(ta.sma(close, ${v})) + 1e-9)`,family:"trend_curvature",complexity:6,feature:C});continue}if(d===1){const M=X(l,Math.min(x,F)),$=X(l,Math.max(x,F)),C=X(l,Math.max(v,F)),A=new Float64Array(l.length);for(let S=0;S<l.length;S+=1)A[S]=(M[S]-2*$[S]+C[S])/(Math.abs(C[S])+1e-9);j({id:`cand_curve_${o}_${x}_${v}_${F}`,expr:`div(add(sub(sma(close,${x}),mul(2,sma(close,${Math.max(x,F)}))),sma(close,${Math.max(v,F)})),abs(sma(close,${Math.max(v,F)})))`,pine:`(ta.sma(close, ${x}) - 2*ta.sma(close, ${Math.max(x,F)}) + ta.sma(close, ${Math.max(v,F)})) / (math.abs(ta.sma(close, ${Math.max(v,F)})) + 1e-9)`,family:"trend_curvature",complexity:8,feature:A});continue}if(d===2){const M=Qe(G,x),$=Qe(G,v),C=new Float64Array(l.length);for(let A=0;A<l.length;A+=1)C[A]=M[A]/($[A]+1e-9)-1;j({id:`cand_vol_shift_${o}_${x}_${v}`,expr:`sub(div(std(ret1(close),${x}),std(ret1(close),${v})),1)`,pine:`(ta.stdev((close-close[1])/(close[1]+1e-9), ${x}) / (ta.stdev((close-close[1])/(close[1]+1e-9), ${v}) + 1e-9)) - 1`,family:"volatility_state",complexity:7,feature:C});continue}if(d===3){const M=X(pe,Math.max(5,x)),$=de(fe,Math.max(5,v)),C=new Float64Array(l.length);for(let A=0;A<l.length;A+=1)C[A]=$[A]*M[A];j({id:`cand_shape_${o}_${x}_${v}`,expr:`mul(ema(wick_asym,${Math.max(5,v)}),sma(div(sub(high,low),close),${Math.max(5,x)}))`,pine:`ta.ema(((high-math.max(open,close))-(math.min(open,close)-low))/(high-low+1e-9), ${Math.max(5,v)}) * ta.sma((high-low)/(math.abs(close)+1e-9), ${Math.max(5,x)})`,family:"range_asymmetry",complexity:8,feature:C});continue}const N=Math.max(5,x),k=X(b,N),P=new Float64Array(l.length);for(let M=0;M<l.length;M+=1){const $=b[M]/(k[M]+1e-9)-1;P[M]=G[M]*$}j({id:`cand_pv_${o}_${N}`,expr:`mul(ret1(close),sub(div(volume,sma(volume,${N})),1))`,pine:`((close-close[1])/(close[1]+1e-9)) * ((volume/(ta.sma(volume, ${N})+1e-9))-1)`,family:"price_volume_coupling",complexity:7,feature:P})}j({id:"cand_range",expr:"sub(high,low)",pine:"high - low",family:"range_asymmetry",complexity:2,feature:oe}),j({id:"cand_range_norm",expr:"div(sub(high,low),close)",pine:"(high-low)/(math.abs(close)+1e-9)",family:"range_asymmetry",complexity:3,feature:pe});const Oe=X(b,21),Re=new Float64Array(l.length);for(let o=0;o<l.length;o+=1)Re[o]=b[o]/(Oe[o]+1e-9)-1;j({id:"cand_volume_ratio",expr:"div(volume,sma(volume,21))",pine:"volume/(ta.sma(volume,21)+1e-9)",family:"price_volume_coupling",complexity:4,feature:Re}),j({id:"cand_wick_asym",expr:"div(sub(upper_wick,lower_wick),range)",pine:"((high-math.max(open,close))-(math.min(open,close)-low))/(high-low+1e-9)",family:"range_asymmetry",complexity:5,feature:de(fe,13)});const be=[],Fe=[],Ae=[],V=l.length,ge=300,ye=140,De=120,Le=I(Math.floor(V*h.holdout_split),De,Math.max(De,V-220)),re=Math.max(ge+ye,V-Le),Ue=Math.floor(V*h.search_split),ve=I(Ue,ge,Math.max(ge,re-ye)),Je=Math.max(ye,Math.floor(V*h.model_select_split)),Ke=Math.max(ve,re-Je);for(const o of i){let d=0;for(const v of f)d=Math.max(d,B(o.expr,v));for(const v of Fe)d=Math.max(d,B(o.expr,v));let _=0;for(const v of Ae)_=Math.max(_,H(o.feature,v));const w=1-H(o.feature,G);if(o.novelty=me(.45*(1-d)+.35*(1-_)+.2*w,0,1),d>m.novelty_similarity_threshold||_>m.collinearity_threshold||o.novelty<m.min_novelty_score)continue;let F=0,x=Number.POSITIVE_INFINITY;for(let v=s.min_bar;v<=s.max_bar;v+=Math.max(2,s.coarse_step*2)){const N=ae(o.feature,0,ve,v,2,Math.max(0,h.purge_bars),Math.max(0,h.embargo_bars));if(!N)continue;const k=L(N.yTrue,N.yPred,N.closeRef,N.foldErrors);k.composite<x&&(x=k.composite,F=v)}Number.isFinite(x)&&F>0&&(be.push({candidate:o,horizon:F,composite:x}),Fe.push(o.expr),Ae.push(o.feature))}be.sort((o,d)=>o.composite-d.composite);const We=be.slice(0,m.stage_a_keep),ne=[];for(const o of We.slice(0,Math.max(12,m.stage_b_keep*Math.max(2,m.tuning_trials)))){const d=o.candidate;let _=null;const w={},F={},x=Math.max(s.min_bar,o.horizon-s.refine_radius),v=Math.min(s.max_bar,o.horizon+s.refine_radius);for(let N=x;N<=v;N+=1){const k=ae(d.feature,Ke,re,N,h.folds,Math.max(0,h.purge_bars),Math.max(0,h.embargo_bars));if(!k)continue;const P=L(k.yTrue,k.yPred,k.closeRef,k.foldErrors),M=Q(d.feature,N,re,Math.max(0,h.purge_bars));if(!M)continue;const $=L(M.yTrue,M.yPred,M.closeRef,k.foldErrors),C=L(M.yTrue,M.closeRef,M.closeRef,[]),A=$.composite<=C.composite-h.baseline_margin,S=[];A||S.push("Holdout composite did not beat baseline margin."),w[N]=P.composite,F[N]={normalizedRmse:$.normalizedRmse,normalizedMae:$.normalizedMae,calibration:$.calibration,composite:$.composite,hitRate:$.hitRate,pnl:$.pnl,maxDrawdown:$.maxDrawdown,turnover:$.turnover,stability:$.stability},(!_||P.composite<_.selectionComposite)&&(_={horizon:N,selectionComposite:P.composite,normalizedRmse:$.normalizedRmse,normalizedMae:$.normalizedMae,calibration:$.calibration,composite:$.composite,hitRate:$.hitRate,pnl:$.pnl,maxDrawdown:$.maxDrawdown,turnover:$.turnover,stability:$.stability,yTrue:M.yTrue,yPred:M.yPred,closeRef:M.closeRef,timestamps:M.timestamps,foldErrors:k.foldErrors,baselineComposite:C.composite,holdoutPassed:A,warnings:S})}_&&ne.push({candidate:{id:d.id,expr:d.expr,pine:d.pine,family:d.family,novelty:d.novelty,complexity:d.complexity},horizon:_.horizon,selectionComposite:_.selectionComposite,normalizedRmse:_.normalizedRmse,normalizedMae:_.normalizedMae,calibration:_.calibration,composite:_.composite,hitRate:_.hitRate,pnl:_.pnl,maxDrawdown:_.maxDrawdown,turnover:_.turnover,stability:_.stability,yTrue:_.yTrue,yPred:_.yPred,closeRef:_.closeRef,timestamps:_.timestamps,foldErrors:_.foldErrors,baselineComposite:_.baselineComposite,holdoutPassed:_.holdoutPassed,warnings:_.warnings,horizonScores:w,horizonDetails:F})}if(!ne.length)throw new Error("No valid candidate found");ne.sort((o,d)=>o.selectionComposite-d.selectionComposite);const R=ne[0],ha=Float64Array.from(ne.slice(0,6).map(o=>o.composite)),ie=[-.05,-.03,-.02,-.01,-.005,0,.005,.01,.02,.03,.05],ke=new Array(ie.length-1).fill(0),ot=new Array(ie.length-1).fill(0);for(let o=0;o<R.yTrue.length;o+=1){const d=(R.yPred[o]-R.closeRef[o])/(R.closeRef[o]+1e-9),_=(R.yTrue[o]-R.closeRef[o])/(R.closeRef[o]+1e-9);for(let w=0;w<ie.length-1;w+=1)if(d>=ie[w]&&d<ie[w+1]){ke[w]+=_,ot[w]+=1;break}}for(let o=0;o<ke.length;o+=1)ke[o]=ot[o]>0?ke[o]/ot[o]:0;const ua=ne.flatMap(o=>Object.keys(o.horizonDetails).map(d=>Number(d)).filter(d=>Number.isFinite(d)).map(d=>({indicator_id:o.candidate.id,expression:o.candidate.expr,family:o.candidate.family,complexity:o.candidate.complexity,novelty_score:o.candidate.novelty,horizon_bar:d,horizon_time_ms:q(r,d),normalized_rmse:o.horizonDetails[d].normalizedRmse,normalized_mae:o.horizonDetails[d].normalizedMae,calibration_error:o.horizonDetails[d].calibration,composite_error:o.horizonDetails[d].composite,directional_hit_rate:o.horizonDetails[d].hitRate,pnl_total:o.horizonDetails[d].pnl,max_drawdown:o.horizonDetails[d].maxDrawdown,turnover:o.horizonDetails[d].turnover,stability_score:o.horizonDetails[d].stability}))),xt=new Float64Array(l.length);for(let o=0;o<l.length-1;o+=1)xt[o]=(l[o+1]-l[o])/(l[o]+1e-9);const Ge=ae(xt,0,ve,Math.max(s.min_bar,3),2,0,0),wt=Ge?L(Ge.yTrue,Ge.yPred,Ge.closeRef,[]).composite<R.composite*.8:!1,rt=[];return R.holdoutPassed||rt.push("Selected indicator did not beat baseline margin on holdout."),wt||rt.push("Leakage sentinel did not trigger strongly; review data leakage checks."),{symbol:"",timeframe:"",timeframeMs:Z(r),candidateId:R.candidate.id,expression:R.candidate.expr,pine:R.candidate.pine,family:R.candidate.family,novelty:R.candidate.novelty,complexity:R.candidate.complexity,horizon:R.horizon,normalizedRmse:R.normalizedRmse,normalizedMae:R.normalizedMae,calibration:R.calibration,composite:R.composite,hitRate:R.hitRate,pnl:R.pnl,maxDrawdown:R.maxDrawdown,turnover:R.turnover,stability:1/(ce(ha)+1e-6),equityCurve:_t(R.yTrue,R.yPred,R.closeRef,.001).equity,horizonScores:R.horizonScores,horizonDetails:R.horizonDetails,frontier:ne.slice(0,14).map(o=>({label:o.candidate.id,expression:o.candidate.expr,family:o.candidate.family,novelty:o.candidate.novelty,complexity:o.candidate.complexity,error:o.composite,hitRate:o.hitRate,pnl:o.pnl,calibration:o.calibration,horizon:o.horizon,pine:o.candidate.pine})),cubeRows:ua,yTrue:R.yTrue,yPred:R.yPred,closeRef:R.closeRef,timestamps:R.timestamps,foldErrors:R.foldErrors,calibrationCurve:{x:ie.slice(0,-1).map((o,d)=>(o+ie[d+1])/2),y:ke},validation:{holdoutRows:R.yTrue.length,holdoutPassed:R.holdoutPassed,baselineComposite:R.baselineComposite,leakageSentinelTriggered:wt,warnings:rt}}}function J(e,t){switch(t){case"directional_hit_rate":return e.directional_hit_rate;case"pnl_total":return e.pnl_total;case"calibration_error":return e.calibration_error;case"composite_error":default:return e.composite_error}}function ze(e){return e==="composite_error"||e==="calibration_error"}function _e(e){switch(e){case"directional_hit_rate":return"Directional Hit Rate";case"pnl_total":return"PnL";case"calibration_error":return"Calibration Error";case"composite_error":default:return"Composite Error"}}function vt(e,t){const a=I(Number((t==null?void 0:t.horizon_minutes)??120),5,10080),r=(t==null?void 0:t.metric)==="directional_hit_rate"||(t==null?void 0:t.metric)==="pnl_total"||(t==null?void 0:t.metric)==="calibration_error"?t.metric:"composite_error",n=Math.max(0,Math.min(1,Number((t==null?void 0:t.min_novelty)??0))),s=e.filter(b=>b.novelty_score>=n),m=new Map;for(const b of s){const g=`${b.symbol}|${b.timeframe}|${b.indicator_id}`,y=m.get(g);y?y.push(b):m.set(g,[b])}const h=[];m.forEach(b=>{if(!b.length)return;b.sort((c,f)=>c.horizon_bar-f.horizon_bar);const g=Dt(b[0].timeframe,a);let y=b[0],i=Math.abs(y.horizon_bar-g);for(let c=1;c<b.length;c+=1){const f=Math.abs(b[c].horizon_bar-g);f<i&&(y=b[c],i=f)}h.push(y)});const l=ze(r)?1:-1;h.sort((b,g)=>l*(J(b,r)-J(g,r)));const u=Array.from(new Set(h.map(b=>`${b.symbol}:${b.timeframe}`))).sort(),z=Array.from(new Set(h.map(b=>`${b.indicator_id} (${b.family})`))).slice(0,24).sort(),p=u.map(b=>z.map(g=>{const y=h.find(i=>`${i.symbol}:${i.timeframe}`===b&&`${i.indicator_id} (${i.family})`===g);return y?J(y,r):Number.NaN}));return{horizonMinutes:a,metric:r,minNovelty:n,rows:h,assets:u,indicators:z,z:p}}function ia(e,t){var y;const a=t.map(i=>({symbol:i.symbol,timeframe:i.timeframe,best_horizon:i.horizon,best_horizon_ms:q(i.timeframe,i.horizon),best_horizon_label:kt(i.timeframe,i.horizon),indicator_combo:[{indicator_id:i.candidateId,expression:i.expression,complexity:i.complexity,params:{family:i.family,novelty:Number(i.novelty.toFixed(4))}}],score:{normalized_rmse:i.normalizedRmse,normalized_mae:i.normalizedMae,calibration_error:i.calibration,composite_error:i.composite,directional_hit_rate:i.hitRate,pnl_total:i.pnl,max_drawdown:i.maxDrawdown,turnover:i.turnover,stability_score:i.stability}})).sort((i,c)=>i.score.composite_error-c.score.composite_error),r=a[0],n={schema_version:"v2",run_id:e,universal_recommendation:{symbol:"UNIVERSAL",timeframe:Array.from(new Set(t.map(i=>i.timeframe))).join("|"),best_horizon:r.best_horizon,best_horizon_ms:r.best_horizon_ms,best_horizon_label:r.best_horizon_label,indicator_combo:r.indicator_combo,score:r.score},per_asset_recommendations:a,validation_report:{leakage_checks_passed:t.every(i=>i.validation.leakageSentinelTriggered&&i.validation.holdoutPassed),leakage_sentinel_triggered:t.every(i=>i.validation.leakageSentinelTriggered),holdout_rows:t.reduce((i,c)=>i+c.validation.holdoutRows,0),holdout_pass_ratio:t.filter(i=>i.validation.holdoutPassed).length/Math.max(t.length,1),baseline_rejection_rate:t.filter(i=>!i.validation.holdoutPassed).length/Math.max(t.length,1),warnings:t.flatMap(i=>i.validation.warnings)},horizon_metadata:{timeframe_ms:{"5m":Z("5m"),"1h":Z("1h"),"4h":Z("4h")},note:"Bars-ahead is translated to wall-clock time based on source timeframe."},per_indicator_frontier:t.flatMap(i=>i.frontier.map(c=>{var f,E,B,H,U,L;return{symbol:i.symbol,timeframe:i.timeframe,indicator_id:c.label,expression:c.expression,family:c.family,complexity:c.complexity,novelty_score:c.novelty,best_horizon:c.horizon,best_horizon_ms:q(i.timeframe,c.horizon),score:{normalized_rmse:((f=i.horizonDetails[c.horizon])==null?void 0:f.normalizedRmse)??i.normalizedRmse,normalized_mae:((E=i.horizonDetails[c.horizon])==null?void 0:E.normalizedMae)??i.normalizedMae,calibration_error:((B=i.horizonDetails[c.horizon])==null?void 0:B.calibration)??i.calibration,composite_error:c.error,directional_hit_rate:c.hitRate,pnl_total:c.pnl,max_drawdown:((H=i.horizonDetails[c.horizon])==null?void 0:H.maxDrawdown)??i.maxDrawdown,turnover:((U=i.horizonDetails[c.horizon])==null?void 0:U.turnover)??i.turnover,stability_score:((L=i.horizonDetails[c.horizon])==null?void 0:L.stability)??i.stability}}})),indicator_cube:t.flatMap(i=>i.cubeRows.map(c=>({symbol:i.symbol,timeframe:i.timeframe,...c}))),generated_at:Y()},s=vt(n.indicator_cube??[],{horizon_minutes:120,metric:"composite_error",min_novelty:0}),m=s.horizonMinutes,h=s.rows,l=s.assets,u=s.indicators,z=s.z,p=t[0],b={indicator_horizon_heatmap:{schema_version:"v2",run_id:e,plot_id:"indicator_horizon_heatmap",title:`Indicator Horizon Heatmap (${m}m ahead, ${_e(s.metric)})`,payload:{type:"heatmap",x:u,y:l,z,x_title:"Indicator",y_title:"Asset / Timeframe",z_title:_e(s.metric),lower_is_better:ze(s.metric),horizon_minutes:m,metric:s.metric,min_novelty:s.minNovelty}},horizon_slice_table:{schema_version:"v2",run_id:e,plot_id:"horizon_slice_table",title:`Horizon Slice Leaderboard (${m}m ahead)`,payload:{type:"table",rows:h.sort((i,c)=>ze(s.metric)?J(i,s.metric)-J(c,s.metric):J(c,s.metric)-J(i,s.metric)).slice(0,80).map((i,c)=>({rank:c+1,asset:`${i.symbol}:${i.timeframe}`,indicator_id:i.indicator_id,family:i.family,formula:i.expression,novelty:i.novelty_score,horizon:`${i.horizon_bar} bars (${ee(i.horizon_time_ms)} @ ${i.timeframe})`,composite_error:i.composite_error,calibration_error:i.calibration_error,directional_hit_rate:i.directional_hit_rate,pnl_total:i.pnl_total,selected_metric:_e(s.metric),selected_value:J(i,s.metric)}))}},forecast_overlay:{schema_version:"v2",run_id:e,plot_id:"forecast_overlay",title:p?`Forecast Overlay (${p.symbol}:${p.timeframe})`:"Forecast Overlay",payload:{type:"line_time",x:Array.from((p==null?void 0:p.timestamps.slice(0,900))??[]),series:p?[{name:"y_true",values:Array.from(p.yTrue.slice(0,900))},{name:"y_pred",values:Array.from(p.yPred.slice(0,900))},{name:"close_ref",values:Array.from(p.closeRef.slice(0,900))}]:[],x_title:"Timestamp",y_title:"Price"}},calibration_curve:{schema_version:"v2",run_id:e,plot_id:"calibration_curve",title:p?`Calibration Curve (${p.symbol}:${p.timeframe})`:"Calibration Curve",payload:{type:"line",x:(p==null?void 0:p.calibrationCurve.x)??[],series:p?[{name:"observed_return",values:p.calibrationCurve.y},{name:"ideal_y=x",values:p.calibrationCurve.x}]:[],x_title:"Predicted Return Bin",y_title:"Observed Return"}},indicator_horizon_profile:{schema_version:"v2",run_id:e,plot_id:"indicator_horizon_profile",title:p?`Indicator vs Horizon (${p.symbol}:${p.timeframe})`:"Indicator vs Horizon",payload:{type:"line",x:p?Object.keys(p.horizonDetails).map(i=>Number(i)).sort((i,c)=>i-c):[],series:p?[{name:`${p.candidateId} composite`,values:Object.keys(p.horizonDetails).map(i=>Number(i)).sort((i,c)=>i-c).map(i=>{var c;return((c=p.horizonDetails[i])==null?void 0:c.composite)??Number.NaN})}]:[],x_title:"Horizon (bars)",y_title:"Composite Error"}},stability_folds:{schema_version:"v2",run_id:e,plot_id:"stability_folds",title:"Fold Stability Overview",payload:{type:"bar",categories:t.slice(0,10).map(i=>`${i.symbol}:${i.timeframe}`),values:t.slice(0,10).map(i=>i.foldErrors.length?i.foldErrors.reduce((c,f)=>c+f,0)/i.foldErrors.length:Number.NaN),x_title:"Asset / Timeframe",y_title:"Mean Fold Composite Error"}},novelty_pareto:{schema_version:"v2",run_id:e,plot_id:"novelty_pareto",title:"Novelty/Complexity vs Accuracy",payload:{type:"scatter",points:t.flatMap(i=>i.frontier.map(c=>({label:`${i.symbol}:${i.timeframe}:${c.label}`,complexity:c.complexity,error:c.error,hit_rate:c.hitRate,pnl:c.pnl,novelty:c.novelty})))}},leaderboard:{schema_version:"v2",run_id:e,plot_id:"leaderboard",title:"Asset Leaderboard",payload:{type:"table",rows:a.map(i=>({asset:`${i.symbol}:${i.timeframe}`,horizon:i.best_horizon_label,composite_error:i.score.composite_error,calibration_error:i.score.calibration_error,hit_rate:i.score.directional_hit_rate,pnl:i.score.pnl_total,turnover:i.score.turnover}))}},formula_inspector:{schema_version:"v2",run_id:e,plot_id:"formula_inspector",title:"Formula Inspector",payload:{type:"table",rows:t.flatMap(i=>i.frontier.slice(0,3).map(c=>({asset:`${i.symbol}:${i.timeframe}`,indicator_id:c.label,family:c.family,novelty_score:c.novelty,complexity:c.complexity,best_horizon:`${c.horizon} bars (${ee(q(i.timeframe,c.horizon))} @ ${i.timeframe})`,formula_dsl:c.expression,explanation:`Family ${c.family} signal with novelty ${c.novelty.toFixed(2)} and complexity ${c.complexity}.`,pine:c.pine})))}}},g={};for(const i of t.slice(0,3))g[`${i.symbol}_${i.timeframe}_indicator.pine`]=`//@version=6
indicator("${i.symbol} ${i.timeframe}", overlay=false)
horizon = ${i.horizon}
value = ${i.pine}
plot(value)
`;return g["universal_indicator.pine"]=`//@version=6
indicator("Novel Indicator Universal", overlay=false)
horizon = ${n.universal_recommendation.best_horizon}
value = ${((y=t[0])==null?void 0:y.pine)??"close"}
plot(value)
`,{summary:n,plots:b,pine:g}}function sa(e,t,a){if(!e.summary)return null;if(t==="indicator_horizon_heatmap"||t==="horizon_slice_table"){const r=vt(e.summary.indicator_cube??[],a);return t==="indicator_horizon_heatmap"?{schema_version:"v2",run_id:e.run.run_id,plot_id:"indicator_horizon_heatmap",title:`Indicator Horizon Heatmap (${r.horizonMinutes}m ahead, ${_e(r.metric)})`,payload:{type:"heatmap",x:r.indicators,y:r.assets,z:r.z,x_title:"Indicator",y_title:"Asset / Timeframe",z_title:_e(r.metric),lower_is_better:ze(r.metric),horizon_minutes:r.horizonMinutes,metric:r.metric,min_novelty:r.minNovelty}}:{schema_version:"v2",run_id:e.run.run_id,plot_id:"horizon_slice_table",title:`Horizon Slice Leaderboard (${r.horizonMinutes}m ahead)`,payload:{type:"table",rows:r.rows.sort((n,s)=>ze(r.metric)?J(n,r.metric)-J(s,r.metric):J(s,r.metric)-J(n,r.metric)).slice(0,120).map((n,s)=>({rank:s+1,asset:`${n.symbol}:${n.timeframe}`,indicator_id:n.indicator_id,family:n.family,formula:n.expression,novelty:n.novelty_score,horizon:`${n.horizon_bar} bars (${ee(n.horizon_time_ms)} @ ${n.timeframe})`,composite_error:n.composite_error,calibration_error:n.calibration_error,directional_hit_rate:n.directional_hit_rate,pnl_total:n.pnl_total,selected_metric:_e(r.metric),selected_value:J(n,r.metric)}))}}}return e.plots[t]??null}async function la(e){var n,s;const t=O.get(e);if(!t)return;const a=Date.now();let r=Date.now();try{te(t,"running","universe",.05,"Selecting Binance universe in browser..."),at(t,{stage:"universe",working_on:"Binance universe query",achieved:"0 symbols",remaining:"pending",overall_progress:.05,stage_progress:.2,run_elapsed_sec:0,stage_elapsed_sec:0,eta_total_sec:null,eta_stage_sec:null,rate_units_per_sec:0}),we(e,t);const m=await oa(t,t.config.top_n_symbols),h=[],l=Math.max(1,m.length*t.config.timeframes.length),u=Math.max(60,t.config.budget_minutes*60);let z=((n=t.config.advanced)==null?void 0:n.performance_profile)==="deep"?1.15:((s=t.config.advanced)==null?void 0:s.performance_profile)==="balanced"?1:.85,p=0;te(t,"running","ingest",.15,`Ingesting ${m.length} symbols from Binance...`),we(e,t);for(const g of m)for(const y of t.config.timeframes){if(Ze.has(e))throw new Error("Run canceled");r=Date.now(),te(t,"running","optimization",Math.min(.85,.15+p/l),`Optimizing ${g} ${y} locally...`);const i=t.config.budget_minutes/Math.max(l,1),c=y==="5m"?i<3?70:i<6?95:130:y==="1h"?i<3?260:i<6?380:620:i<3?420:i<6?730:1050,E=Math.max(y==="5m"?40:y==="1h"?160:280,Math.floor(c*z)),B=await ra(t,g,y,E);if(B.length>600)try{const Q=t.config.seed_mode==="manual"?t.config.random_seed??42:42,j=na(B,Yt(Q,g,y),t.config,y);j.symbol=g,j.timeframe=y,h.push(j)}catch(Q){t.run.logs.push({timestamp:Y(),stage:"optimization",message:`Skipped ${g} ${y}: ${Q.message}`})}else t.run.logs.push({timestamp:Y(),stage:"ingest",message:`Skipped ${g} ${y}: insufficient candles (${B.length}).`});p+=1;const H=Math.max((Date.now()-a)/1e3,.1),U=H/Math.max(p,1),L=Math.max(0,l-p);U*l>u*1.1&&z>.55&&(z=Math.max(.55,z*.85),t.run.logs.push({timestamp:Y(),stage:"optimization",message:`Adaptive downscale applied: reducing lookback depth to ${Math.round(z*100)}% to stay within budget.`})),at(t,{stage:"optimization",working_on:`${g} ${y}`,achieved:`${p}/${l} datasets`,remaining:`${L} datasets`,overall_progress:Math.min(.85,.15+p/l),stage_progress:p/l,run_elapsed_sec:H,stage_elapsed_sec:(Date.now()-r)/1e3,eta_total_sec:U*L,eta_stage_sec:U,rate_units_per_sec:p/H}),we(e,t)}if(!h.length)throw new Error("No valid datasets produced results");te(t,"running","ranking",.92,"Building summary and visual diagnostics...");const b=ia(e,h);t.summary=b.summary,t.plots=b.plots,t.pineScripts=b.pine,te(t,"completed","finished",1,"Run completed fully in browser compute engine."),at(t,{stage:"finished",working_on:"Complete",achieved:"Run completed",remaining:"0",overall_progress:1,stage_progress:1,run_elapsed_sec:(Date.now()-a)/1e3,stage_elapsed_sec:(Date.now()-r)/1e3,eta_total_sec:0,eta_stage_sec:0,rate_units_per_sec:p/Math.max((Date.now()-a)/1e3,.1)}),we(e,t),await tt()}catch(m){m.message==="Run canceled"?te(t,"canceled","finished",1,"Run canceled by user."):(t.run.error=m.message,te(t,"failed","finished",1,`Run failed: ${m.message}`)),we(e,t),await tt()}finally{Ze.delete(e)}}function ca(){return Array.from(O.values()).map(e=>e.run).sort((e,t)=>Date.parse(t.created_at)-Date.parse(e.created_at))}function ma(e){return{run_id:e.run.run_id,source_version:"web-local-v2",sync_state:"synced",retained_at:Y(),config:e.config,summary:e.summary,plots:Object.values(e.plots).map(t=>({plot_id:t.plot_id,payload:t.payload}))}}async function da(e){var t,a,r,n,s,m,h,l,u,z,p,b,g,y,i;switch(await Qt(),e.method){case"init":return{ok:!0};case"createRun":{const c=Array.from(O.values()).find(U=>U.run.status==="queued"||U.run.status==="running");if(c)throw new Error(`Run already active (${c.run.run_id}). Cancel or wait before starting another.`);const f=et((t=e.params)==null?void 0:t.config),E=Gt(),B=ea(E,f);return O.set(E,B),await gt(E,B),la(E),{run_id:E,status:"queued",created_at:B.run.created_at}}case"listRuns":return ca();case"getRun":{const c=String(((a=e.params)==null?void 0:a.runId)??""),f=O.get(c);if(!f)throw new Error("Run not found");return f.run}case"getResults":{const c=String(((r=e.params)==null?void 0:r.runId)??""),f=O.get(c);if(!(f!=null&&f.summary))throw new Error("Results not found");return f.summary}case"getPlot":{const c=String(((n=e.params)==null?void 0:n.runId)??""),f=String(((s=e.params)==null?void 0:s.plotId)??""),E=O.get(c);if(!E)throw new Error("Run not found");const B=(m=e.params)==null?void 0:m.options,H=sa(E,f,B);if(!H)throw new Error("Plot not found");return H}case"getTelemetry":{const c=String(((h=e.params)==null?void 0:h.runId)??""),f=Number(((l=e.params)==null?void 0:l.limit)??300),E=O.get(c);if(!E)throw new Error("Run not found");return{run_id:c,snapshots:E.telemetry.slice(-Math.max(1,Math.min(2e3,f)))}}case"getBinanceDiagnostics":{const c=String(((u=e.params)==null?void 0:u.runId)??""),f=Number(((z=e.params)==null?void 0:z.limit)??40),E=O.get(c);if(!E)throw new Error("Run not found");return{run_id:c,calls:E.binanceCalls.slice(-Math.max(1,Math.min(240,f)))}}case"cancelRun":{const c=String(((p=e.params)==null?void 0:p.runId)??"");if(!O.has(c))throw new Error("Run not found");return Ze.add(c),{ok:!0}}case"generateReport":{const c=String(((b=e.params)==null?void 0:b.runId)??""),f=O.get(c);if(!(f!=null&&f.summary))throw new Error("Run not found");return{html:ft(f)}}case"exportPine":{const c=String(((g=e.params)==null?void 0:g.runId)??""),f=O.get(c);if(!(f!=null&&f.summary))throw new Error("Run not found");return{files:f.pineScripts}}case"exportRunBundle":{const c=String(((y=e.params)==null?void 0:y.runId)??""),f=O.get(c);if(!(f!=null&&f.summary))throw new Error("Run not found");return It(f)}case"getRunStoragePayload":{const c=String(((i=e.params)==null?void 0:i.runId)??""),f=O.get(c);if(!(f!=null&&f.summary))throw new Error("Run not found");return ma(f)}default:throw new Error(`Unknown method ${e.method}`)}}self.onmessage=async e=>{const t=e.data;if(!(!(t!=null&&t.id)||!t.method))try{const a=await da(t),r={id:t.id,ok:!0,result:a};self.postMessage(r)}catch(a){const r={id:t.id,ok:!1,error:a.message};self.postMessage(r)}}})();
